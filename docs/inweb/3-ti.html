<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>The Indexer</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Octagram184x184.png" width=72 height=72">
</a></h1>
<ul><li><a href="index.html"><span class="selectedlink">inweb</span></a></li>
</ul><h2>Foundation Module</h2><ul>
<li><a href="../foundation-module/index.html">foundation</a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
</ul><h2>Example Webs</h2><ul>
<li><a href="../goldbach/index.html">goldbach</a></li>
<li><a href="../twinprimes/twinprimes.html">twinprimes</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/inweb"><img src="../github.png" height=18> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inform/docs/index.html">inform</a></li>
<li><a href="../../../intest/docs/index.html">intest</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'The Indexer' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">inweb</a></li><li><a href="index.html#3">Chapter 3: Outputs</a></li><li><b>The Indexer</b></li></ul><p class="purpose">To construct indexes of the material woven, following a template.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Cover sheets</a></li><li><a href="#SP3">&#167;3. Full index pages</a></li><li><a href="#SP6_1_1">&#167;6.1.1. The repeat stack and loops</a></li><li><a href="#SP6_1_8">&#167;6.1.8. Variable substitutions</a></li><li><a href="#SP8">&#167;8. Transcribing CSS</a></li><li><a href="#SP9">&#167;9. Tracking the file being written to</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Cover sheets. </b>The indexer offers two basic services. One, which is much simpler, makes
cover sheets, and has only simple escapes (except that it has the ability
to call the fuller indexing service if need be, using <code class="display"><span class="extract">[[Template T]]</span></code>
or <code class="display"><span class="extract">[[Navigation]]</span></code>).
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::cover_sheet_maker<button class="popup" onclick="togglePopup('usagePopup71')">...<span class="popuptext" id="usagePopup71">Usage of <b>Indexer::cover_sheet_maker</b>:<br><a href="#SP2_1_1">&#167;2.1.1</a>, The Weaver - <a href="3-tw.html#SP1_2">&#167;1.2</a>, <a href="3-tw.html#SP1_4">&#167;1.4</a><br>HTML Formats - <a href="5-hf.html#SP5">&#167;5</a>, <a href="5-hf.html#SP28">&#167;28</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">unextended_leafname</span><span class="plain">,</span>
        <span class="reserved">weave_target</span><span class="plain"> *</span><span class="identifier">wt</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">halves</span><span class="plain">) {</span>
        <span class="reserved">cover_sheet_state</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Clear the cover sheet state</span> <span class="cwebmacronumber">1.2</span>&gt;<span class="plain">;</span>

        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">extended_leafname</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">extended_leafname</span><span class="plain">, </span><span class="string">"%S%S"</span><span class="plain">, </span><span class="identifier">unextended_leafname</span><span class="plain">, </span><span class="functiontext"><a href="5-fm.html#SP2">Formats::file_extension</a></span><span class="plain">(</span><span class="identifier">wt</span><span class="plain">-&gt;</span><span class="element">format</span><span class="plain">));</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">cs_filename</span><span class="plain"> = </span><span class="functiontext"><a href="1-ptt.html#SP5">Patterns::obtain_filename</a></span><span class="plain">(</span><span class="identifier">wt</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">, </span><span class="identifier">extended_leafname</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">extended_leafname</span><span class="plain">);</span>

        <span class="functiontext"><a href="4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">cs_filename</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open cover sheet file"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">,</span>
            <span class="functiontext"><a href="#SP2">Indexer::scan_cover_line</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, (</span><span class="reserved">void</span><span class="plain"> *) &amp;</span><span class="identifier">state</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP1_1"></a><b>&#167;1.1.  </b>The cover-sheet-maker has the ability to weave only the top half, or only
the bottom half, of the template; they are divided by the marker <code class="display"><span class="extract">[[Code]]</span></code>.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">WEAVE_FIRST_HALF</span><span class="plain"> </span><span class="constant">1</span>
    <span class="definitionkeyword">define</span> <span class="constant">WEAVE_SECOND_HALF</span><span class="plain"> </span><span class="constant">2</span>
    <span class="definitionkeyword">define</span> <span class="constant">IN_SECOND_HALF</span><span class="plain"> </span><span class="constant">4</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">cover_sheet_state</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">WEAVE_COVER_TO</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">halves</span><span class="plain">; </span><span class="comment"> a bitmap of the above values</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">weave_target</span><span class="plain"> *</span><span class="identifier">target</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">cover_sheet_state</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure cover_sheet_state is private to this section.</p>

<p class="inwebparagraph"><a id="SP1_2"></a><b>&#167;1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Clear the cover sheet state</span> <span class="cwebmacronumber">1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">state</span><span class="plain">.</span><span class="element">halves</span><span class="plain"> = </span><span class="identifier">halves</span><span class="plain">;</span>
        <span class="identifier">state</span><span class="plain">.</span><span class="element">WEAVE_COVER_TO</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="identifier">state</span><span class="plain">.</span><span class="element">target</span><span class="plain"> = </span><span class="identifier">wt</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1">&#167;1</a>.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>The above, then, iterates the following routine on each line of the template
file one by one, passing it a pointer to an instance of the above state
structure.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::scan_cover_line<button class="popup" onclick="togglePopup('usagePopup72')">...<span class="popuptext" id="usagePopup72">Usage of <b>Indexer::scan_cover_line</b>:<br><a href="#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">v_state</span><span class="plain">) {</span>
        <span class="reserved">cover_sheet_state</span><span class="plain"> *</span><span class="identifier">state</span><span class="plain"> = (</span><span class="reserved">cover_sheet_state</span><span class="plain"> *) </span><span class="identifier">v_state</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">WEAVE_COVER_TO</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">include</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (((</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> &amp; </span><span class="constant">WEAVE_FIRST_HALF</span><span class="plain">) &amp;&amp;</span>
                <span class="plain">((</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> &amp; </span><span class="constant">IN_SECOND_HALF</span><span class="plain">) == </span><span class="constant">0</span><span class="plain">)) ||</span>
            <span class="plain">((</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> &amp; </span><span class="constant">WEAVE_SECOND_HALF</span><span class="plain">) &amp;&amp;</span>
                <span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> &amp; </span><span class="constant">IN_SECOND_HALF</span><span class="plain">))) </span><span class="identifier">include</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>

        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">matter</span><span class="plain">);</span>
        <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">matter</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">include</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">((</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">self_contained</span><span class="plain">) || (</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">-&gt;</span><span class="element">embed_CSS</span><span class="plain">)) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">matter</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *%&lt;link href=%\"(%c+?)\"%c*"</span><span class="plain">))) {</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CSS_file</span><span class="plain"> = </span><span class="functiontext"><a href="1-ptt.html#SP5">Patterns::obtain_filename</a></span><span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            <span class="functiontext"><a href="#SP8">Indexer::transcribe_CSS</a></span><span class="plain">(</span><span class="identifier">matter</span><span class="plain">, </span><span class="identifier">CSS_file</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">matter</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)%[%[(%c*?)%]%](%c*)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">left</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">command</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1];</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">right</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[2];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">left</span><span class="plain">);</span>
                &lt;<span class="cwebmacro">Deal with a double-squares escape in a cover sheet</span> <span class="cwebmacronumber">2.1</span>&gt;<span class="plain">;</span>
                <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">matter</span><span class="plain">, </span><span class="identifier">right</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\n"</span><span class="plain">, </span><span class="identifier">matter</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">matter</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2_1"></a><b>&#167;2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Deal with a double-squares escape in a cover sheet</span> <span class="cwebmacronumber">2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr2</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Code"</span><span class="plain">)) {</span>
            <span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> |= </span><span class="constant">IN_SECOND_HALF</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Plugins"</span><span class="plain">)) {</span>
            <span class="reserved">weave_plugin</span><span class="plain"> *</span><span class="identifier">wp</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">wp</span><span class="plain">, </span><span class="reserved">weave_plugin</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">plugins</span><span class="plain">)</span>
                <span class="functiontext"><a href="5-wp.html#SP3">WeavePlugins::include</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">weave_web</span><span class="plain">, </span><span class="identifier">wp</span><span class="plain">,</span>
                    <span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Cover Sheet"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span>&lt;<span class="cwebmacro">Weave in the parent pattern's cover sheet</span> <span class="cwebmacronumber">2.1.1</span>&gt;<span class="character">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Navigation"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span>&lt;<span class="cwebmacro">Weave in navigation</span> <span class="cwebmacronumber">2.1.2</span>&gt;<span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Template (%c*?)"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span>&lt;<span class="cwebmacro">Weave in an index</span> <span class="cwebmacronumber">2.1.3</span>&gt;<span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="8-bdfw.html#SP6">Bibliographic::data_exists</a></span><span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">weave_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span>&lt;<span class="cwebmacro">Weave in the value of this variable name</span> <span class="cwebmacronumber">2.1.4</span>&gt;<span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">include</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP2_1_1"></a><b>&#167;2.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Weave in the parent pattern's cover sheet</span> <span class="cwebmacronumber">2.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="identifier">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">-&gt;</span><span class="element">based_on</span><span class="plain">) {</span>
            <span class="reserved">weave_pattern</span><span class="plain"> *</span><span class="identifier">saved</span><span class="plain"> = </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">;</span>
            <span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain"> = </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">-&gt;</span><span class="element">based_on</span><span class="plain">;</span>
            <span class="functiontext"><a href="#SP1">Indexer::cover_sheet_maker</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">weave_web</span><span class="plain">,</span>
                <span class="identifier">I</span><span class="string">"cover-sheet"</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">,</span>
                <span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">halves</span><span class="plain"> &amp; (</span><span class="constant">WEAVE_FIRST_HALF</span><span class="plain"> + </span><span class="constant">WEAVE_SECOND_HALF</span><span class="plain">)));</span>
            <span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain"> = </span><span class="identifier">saved</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="functiontext"><a href="3-em.html#SP5">Errors::in_text_file</a></span><span class="plain">(</span><span class="string">"cover sheet recursively includes itself"</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2_1">&#167;2.1</a>.</p>

<p class="inwebparagraph"><a id="SP2_1_2"></a><b>&#167;2.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Weave in navigation</span> <span class="cwebmacronumber">2.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="identifier">target</span><span class="plain">-&gt;</span><span class="element">navigation</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-tf.html#SP1">TextFiles::exists</a></span><span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">navigation</span><span class="plain">))</span>
                <span class="functiontext"><a href="#SP3">Indexer::incorporate_template_for_target</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">navigation</span><span class="plain">);</span>
            <span class="reserved">else</span>
                <span class="functiontext"><a href="3-em.html#SP2">Errors::fatal_with_file</a></span><span class="plain">(</span><span class="string">"unable to find navigation file"</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">navigation</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Warning: no sidebar links will be generated, as -navigation is unset"</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2_1">&#167;2.1</a>.</p>

<p class="inwebparagraph"><a id="SP2_1_3"></a><b>&#167;2.1.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Weave in an index</span> <span class="cwebmacronumber">2.1.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CF</span><span class="plain"> = </span><span class="functiontext"><a href="1-ptt.html#SP5">Patterns::obtain_filename</a></span><span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">, </span><span class="identifier">mr2</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">CF</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-em.html#SP5">Errors::in_text_file</a></span><span class="plain">(</span><span class="string">"pattern does not provide this template file"</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="functiontext"><a href="#SP3">Indexer::incorporate_template_for_target</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">, </span><span class="identifier">CF</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2_1">&#167;2.1</a>.</p>

<p class="inwebparagraph"><a id="SP2_1_4"></a><b>&#167;2.1.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Weave in the value of this variable name</span> <span class="cwebmacronumber">2.1.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="functiontext"><a href="8-bdfw.html#SP6">Bibliographic::get_datum</a></span><span class="plain">(</span><span class="identifier">state</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain">-&gt;</span><span class="element">weave_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2_1">&#167;2.1</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Full index pages. </b>This is a much more substantial service, and operates as a little processor
interpreting a meta-language all of its very own, with a stack for holding
nested repeat loops, and a program counter and &mdash; well, and nothing else to
speak of, in fact, except for the slightly unusual way that loop variables
provide context by changing the subject of what is discussed rather than by
being accessed directly.
</p>

<p class="inwebparagraph">For convenience, we provide three way to call:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::incorporate_template_for_web_and_pattern<button class="popup" onclick="togglePopup('usagePopup73')">...<span class="popuptext" id="usagePopup73">Usage of <b>Indexer::incorporate_template_for_web_and_pattern</b>:<br>HTML Formats - <a href="5-hf.html#SP19">&#167;19</a><br>Weave Plugins - <a href="5-wp.html#SP3">&#167;3</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">, </span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">,</span>
        <span class="reserved">weave_pattern</span><span class="plain"> *</span><span class="identifier">pattern</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="functiontext"><a href="#SP3">Indexer::incorporate_template</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">I</span><span class="string">""</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="identifier">pattern</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::incorporate_template_for_target<button class="popup" onclick="togglePopup('usagePopup74')">...<span class="popuptext" id="usagePopup74">Usage of <b>Indexer::incorporate_template_for_target</b>:<br><a href="#SP2_1_2">&#167;2.1.2</a>, <a href="#SP2_1_3">&#167;2.1.3</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">, </span><span class="reserved">weave_target</span><span class="plain"> *</span><span class="identifier">wv</span><span class="plain">,</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="functiontext"><a href="#SP3">Indexer::incorporate_template</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">wv</span><span class="plain">-&gt;</span><span class="element">weave_web</span><span class="plain">, </span><span class="identifier">wv</span><span class="plain">-&gt;</span><span class="element">weave_range</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="identifier">wv</span><span class="plain">-&gt;</span><span class="element">pattern</span><span class="plain">,</span>
            <span class="identifier">wv</span><span class="plain">-&gt;</span><span class="element">navigation</span><span class="plain">, </span><span class="identifier">wv</span><span class="plain">-&gt;</span><span class="element">breadcrumbs</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::incorporate_template<button class="popup" onclick="togglePopup('usagePopup75')">...<span class="popuptext" id="usagePopup75">Usage of <b>Indexer::incorporate_template</b>:<br><a href="#SP6_1_8_2">&#167;6.1.8.2</a>, The Swarm - <a href="3-ts.html#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">, </span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range</span><span class="plain">,</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">template_filename</span><span class="plain">, </span><span class="reserved">weave_pattern</span><span class="plain"> *</span><span class="identifier">pattern</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">nav_file</span><span class="plain">,</span>
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">crumbs</span><span class="plain">) {</span>
        <span class="reserved">index_engine_state</span><span class="plain"> </span><span class="identifier">actual_ies</span><span class="plain"> =</span>
            <span class="functiontext"><a href="#SP4">Indexer::new_processor</a></span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">range</span><span class="plain">, </span><span class="identifier">template_filename</span><span class="plain">, </span><span class="identifier">pattern</span><span class="plain">, </span><span class="identifier">nav_file</span><span class="plain">, </span><span class="identifier">crumbs</span><span class="plain">);</span>
        <span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain"> = &amp;</span><span class="identifier">actual_ies</span><span class="plain">;</span>
        <span class="functiontext"><a href="#SP6">Indexer::run_engine</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>The current state of the processor is recorded in the following.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">TRACE_CI_EXECUTION</span><span class="plain"> </span><span class="constant">FALSE</span><span class="plain"> </span><span class="comment"> set true for debugging</span>
    <span class="definitionkeyword">define</span> <span class="constant">MAX_TEMPLATE_LINES</span><span class="plain"> </span><span class="constant">8192</span><span class="plain"> </span><span class="comment"> maximum number of lines in template</span>
    <span class="definitionkeyword">define</span> <span class="constant">CI_STACK_CAPACITY</span><span class="plain"> </span><span class="constant">8</span><span class="plain"> </span><span class="comment"> maximum recursion of chapter/section iteration</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">index_engine_state</span><span class="plain"> {</span>
        <span class="reserved">web</span><span class="plain"> *</span><span class="identifier">for_web</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tlines</span><span class="plain">[</span><span class="constant">MAX_TEMPLATE_LINES</span><span class="plain">];</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_tlines</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">repeat_stack_level</span><span class="plain">[</span><span class="constant">CI_STACK_CAPACITY</span><span class="plain">];</span>
        <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">repeat_stack_variable</span><span class="plain">[</span><span class="constant">CI_STACK_CAPACITY</span><span class="plain">];</span>
        <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">repeat_stack_threshold</span><span class="plain">[</span><span class="constant">CI_STACK_CAPACITY</span><span class="plain">];</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">repeat_stack_startpos</span><span class="plain">[</span><span class="constant">CI_STACK_CAPACITY</span><span class="plain">];</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">stack_pointer</span><span class="plain">; </span><span class="comment"> And this is our stack pointer for tracking of loops</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">restrict_to_range</span><span class="plain">;</span>
        <span class="reserved">weave_pattern</span><span class="plain"> *</span><span class="identifier">nav_pattern</span><span class="plain">;</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">nav_file</span><span class="plain">;</span>
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">crumbs</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">inside_navigation_submenu</span><span class="plain">;</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">errors_at</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">index_engine_state</span><span class="plain">;</span>

    <span class="reserved">index_engine_state</span><span class="plain"> </span><span class="functiontext">Indexer::new_processor<button class="popup" onclick="togglePopup('usagePopup76')">...<span class="popuptext" id="usagePopup76">Usage of <b>Indexer::new_processor</b>:<br><a href="#SP3">&#167;3</a></span></button></span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range</span><span class="plain">,</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">template_filename</span><span class="plain">, </span><span class="reserved">weave_pattern</span><span class="plain"> *</span><span class="identifier">pattern</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">nav_file</span><span class="plain">,</span>
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">crumbs</span><span class="plain">) {</span>
        <span class="reserved">index_engine_state</span><span class="plain"> </span><span class="identifier">ies</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">no_tlines</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">restrict_to_range</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">range</span><span class="plain">);</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">stack_pointer</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">inside_navigation_submenu</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">for_web</span><span class="plain"> = </span><span class="identifier">W</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">nav_pattern</span><span class="plain"> = </span><span class="identifier">pattern</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">nav_file</span><span class="plain"> = </span><span class="identifier">nav_file</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">crumbs</span><span class="plain"> = </span><span class="identifier">crumbs</span><span class="plain">;</span>
        <span class="identifier">ies</span><span class="plain">.</span><span class="element">errors_at</span><span class="plain"> = </span><span class="identifier">template_filename</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Read in the source file containing the contents page template</span> <span class="cwebmacronumber">4.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">ies</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure index_engine_state is accessed in 6/mkf, 6/gs, 6/cln and here.</p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Read in the source file containing the contents page template</span> <span class="cwebmacronumber">4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">template_filename</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">,</span>
            <span class="string">"can't find contents template"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">, </span><span class="functiontext"><a href="#SP5">Indexer::temp_line</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">ies</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_CI_EXECUTION</span><span class="plain">)</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Read template &lt;%f&gt;: %d line(s)\n"</span><span class="plain">, </span><span class="identifier">template_filename</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">.</span><span class="element">no_tlines</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">.</span><span class="element">no_tlines</span><span class="plain"> &gt;= </span><span class="constant">MAX_TEMPLATE_LINES</span><span class="plain">)</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Warning: template &lt;%f&gt; truncated after %d line(s)\n"</span><span class="plain">,</span>
                <span class="identifier">template_filename</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">.</span><span class="element">no_tlines</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::temp_line<button class="popup" onclick="togglePopup('usagePopup77')">...<span class="popuptext" id="usagePopup77">Usage of <b>Indexer::temp_line</b>:<br><a href="#SP4_1">&#167;4.1</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">v_ies</span><span class="plain">) {</span>
        <span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain"> = (</span><span class="reserved">index_engine_state</span><span class="plain"> *) </span><span class="identifier">v_ies</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">no_tlines</span><span class="plain"> &lt; </span><span class="constant">MAX_TEMPLATE_LINES</span><span class="plain">)</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">tlines</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">no_tlines</span><span class="plain">++] = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>Running the engine...
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::run_engine<button class="popup" onclick="togglePopup('usagePopup78')">...<span class="popuptext" id="usagePopup78">Usage of <b>Indexer::run_engine</b>:<br><a href="#SP3">&#167;3</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">, </span><span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain">) {</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">save_cf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">();</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">lpos</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="comment"> This is our program counter: a line number in the template</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">lpos</span><span class="plain"> &lt; </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">no_tlines</span><span class="plain">) {</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">tlines</span><span class="plain">[</span><span class="identifier">lpos</span><span class="plain">++]); </span><span class="comment"> Fetch the line at the program counter and advance</span>
            &lt;<span class="cwebmacro">Make any necessary substitutions to turn tl into final output</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\n"</span><span class="plain">, </span><span class="identifier">tl</span><span class="plain">); </span><span class="comment"> Copy the now finished line to the output</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">);</span>
            <span class="identifier">CYCLE:</span><span class="plain"> ;</span>
            <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/ul&gt;"</span><span class="plain">);</span>
        <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="functiontext"><a href="#SP9">Indexer::set_current_file</a></span><span class="plain">(</span><span class="identifier">save_cf</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Make any necessary substitutions to turn tl into final output</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?) "</span><span class="plain">)) </span><span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]); </span><span class="comment"> Strip trailing spaces</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_CI_EXECUTION</span><span class="plain">)</span>
            &lt;<span class="cwebmacro">Print line and contents of repeat stack</span> <span class="cwebmacronumber">6.1.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="identifier">nav_pattern</span><span class="plain">-&gt;</span><span class="element">embed_CSS</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *%&lt;link href=%\"(%c+?)\"%c*"</span><span class="plain">))) {</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CSS_file</span><span class="plain"> = </span><span class="functiontext"><a href="1-ptt.html#SP5">Patterns::obtain_filename</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            <span class="functiontext"><a href="#SP8">Indexer::transcribe_CSS</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">CSS_file</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%[%[(%c+)%]%]"</span><span class="plain">)) ||</span>
            <span class="plain">(</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" %[%[(%c+)%]%]"</span><span class="plain">))) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">command</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            &lt;<span class="cwebmacro">Deal with a Select command</span> <span class="cwebmacronumber">6.1.2</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">Deal with a Repeat command</span> <span class="cwebmacronumber">6.1.3</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">Deal with a Repeat End command</span> <span class="cwebmacronumber">6.1.4</span>&gt;<span class="plain">;</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">command</span><span class="plain">);</span>
        <span class="plain">}</span>
        &lt;<span class="cwebmacro">Skip line if inside an empty loop</span> <span class="cwebmacronumber">6.1.5</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Make substitutions of square-bracketed variables in line</span> <span class="cwebmacronumber">6.1.8</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_1"></a><b>&#167;6.1.1. The repeat stack and loops. </b>This is used only for debugging:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Print line and contents of repeat stack</span> <span class="cwebmacronumber">6.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%04d: %S\nStack:"</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">-1, </span><span class="identifier">tl</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">=0; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">] == </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">)</span>
                <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">" %d: %S/%S"</span><span class="plain">,</span>
                    <span class="identifier">j</span><span class="plain">, ((</span><span class="reserved">chapter</span><span class="plain"> *)</span>
                        <span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">], </span><span class="reserved">chapter</span><span class="plain">))-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_range</span><span class="plain">,</span>
                    <span class="plain">((</span><span class="reserved">chapter</span><span class="plain"> *)</span>
                        <span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">], </span><span class="reserved">chapter</span><span class="plain">))-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_range</span><span class="plain">);</span>
            <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">] == </span><span class="constant">SECTION_LEVEL</span><span class="plain">)</span>
                <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">" %d: %S/%S"</span><span class="plain">,</span>
                    <span class="identifier">j</span><span class="plain">, ((</span><span class="reserved">section</span><span class="plain"> *)</span>
                        <span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">], </span><span class="reserved">section</span><span class="plain">))-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_range</span><span class="plain">,</span>
                    <span class="plain">((</span><span class="reserved">section</span><span class="plain"> *)</span>
                        <span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">], </span><span class="reserved">section</span><span class="plain">))-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_range</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"\n"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_2"></a><b>&#167;6.1.2.  </b>We start the direct commands with Select, which is implemented as a
one-iteration loop in which the loop variable has the given section or
chapter as its value during the sole iteration.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Deal with a Select command</span> <span class="cwebmacronumber">6.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Select (%c*)"</span><span class="plain">)) {</span>
            <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
            <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">)</span>
                <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">sections</span><span class="plain">)</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_range</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0])) {</span>
                        <span class="functiontext"><a href="#SP6_1_7">Indexer::start_CI_loop</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="constant">SECTION_LEVEL</span><span class="plain">, </span><span class="identifier">S_item</span><span class="plain">, </span><span class="identifier">S_item</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
                        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
                        <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
                    <span class="plain">}</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_range</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0])) {</span>
                    <span class="functiontext"><a href="#SP6_1_7">Indexer::start_CI_loop</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">, </span><span class="identifier">C_item</span><span class="plain">, </span><span class="identifier">C_item</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
                    <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
                    <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
                <span class="plain">}</span>
            <span class="functiontext"><a href="3-em.html#SP6">Errors::at_position</a></span><span class="plain">(</span><span class="string">"don't recognise the chapter or section abbreviation range"</span><span class="plain">,</span>
                <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">errors_at</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_3"></a><b>&#167;6.1.3.  </b>Next, a genuine loop beginning:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Deal with a Repeat command</span> <span class="cwebmacronumber">6.1.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">loop_level</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Repeat Chapter"</span><span class="plain">)) </span><span class="identifier">loop_level</span><span class="plain"> = </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Repeat Section"</span><span class="plain">)) </span><span class="identifier">loop_level</span><span class="plain"> = </span><span class="constant">SECTION_LEVEL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">loop_level</span><span class="plain"> != </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">, *</span><span class="identifier">to</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">CI</span><span class="plain"> = </span><span class="identifier">FIRST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">);</span>
            <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">CI</span><span class="plain">) &amp;&amp; (</span><span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">CI</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">)-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">imported</span><span class="plain">))</span>
                <span class="identifier">CI</span><span class="plain"> = </span><span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">CI</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">loop_level</span><span class="plain"> == </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">) {</span>
                <span class="identifier">from</span><span class="plain"> = </span><span class="identifier">CI</span><span class="plain">;</span>
                <span class="identifier">to</span><span class="plain"> = </span><span class="identifier">LAST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">restrict_to_range</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"0"</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) {</span>
                    <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
                    <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">)</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_range</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">restrict_to_range</span><span class="plain">)) {</span>
                            <span class="identifier">from</span><span class="plain"> = </span><span class="identifier">C_item</span><span class="plain">; </span><span class="identifier">to</span><span class="plain"> = </span><span class="identifier">from</span><span class="plain">;</span>
                            <span class="reserved">break</span><span class="plain">;</span>
                        <span class="plain">}</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">loop_level</span><span class="plain"> == </span><span class="constant">SECTION_LEVEL</span><span class="plain">) {</span>
                <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">within_chapter</span><span class="plain"> =</span>
                    <span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="functiontext"><a href="#SP6_1_6">Indexer::heading_topmost_on_stack</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">),</span>
                        <span class="reserved">chapter</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">within_chapter</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">CI</span><span class="plain">) {</span>
                        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">CI</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">);</span>
                        <span class="identifier">from</span><span class="plain"> = </span><span class="identifier">FIRST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">sections</span><span class="plain">);</span>
                    <span class="plain">}</span>
                    <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">LC</span><span class="plain"> = </span><span class="identifier">LAST_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">chapters</span><span class="plain">);</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">LC</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> = </span><span class="identifier">LAST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">LC</span><span class="plain">-&gt;</span><span class="element">sections</span><span class="plain">);</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                    <span class="identifier">from</span><span class="plain"> = </span><span class="identifier">FIRST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">within_chapter</span><span class="plain">-&gt;</span><span class="element">sections</span><span class="plain">);</span>
                    <span class="identifier">to</span><span class="plain"> = </span><span class="identifier">LAST_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">within_chapter</span><span class="plain">-&gt;</span><span class="element">sections</span><span class="plain">);</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain">) </span><span class="functiontext"><a href="#SP6_1_7">Indexer::start_CI_loop</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="identifier">loop_level</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">to</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
            <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_4"></a><b>&#167;6.1.4.  </b>And at the other bookend:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Deal with a Repeat End command</span> <span class="cwebmacronumber">6.1.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"End Repeat"</span><span class="plain">)) ||</span>
            <span class="plain">(</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"End Select"</span><span class="plain">))) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain"> &lt;= </span><span class="constant">0</span><span class="plain">)</span>
                <span class="functiontext"><a href="3-em.html#SP6">Errors::at_position</a></span><span class="plain">(</span><span class="string">"stack underflow on contents template"</span><span class="plain">,</span>
                    <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">errors_at</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="identifier">stack_pointer</span><span class="plain">-1] == </span><span class="constant">SECTION_LEVEL</span><span class="plain">) {</span>
                <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">SI</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1];</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">SI</span><span class="plain"> == </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1]) ||</span>
                    <span class="plain">(</span><span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">SI</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">) == </span><span class="identifier">NULL</span><span class="plain">))</span>
                    <span class="functiontext"><a href="#SP6_1_7">Indexer::end_CI_loop</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> {</span>
                    <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1] =</span>
                        <span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">SI</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">);</span>
                    <span class="identifier">lpos</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_startpos</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1]; </span><span class="comment"> Back round loop</span>
                <span class="plain">}</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">CI</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">CI</span><span class="plain"> == </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1])</span>
                    <span class="functiontext"><a href="#SP6_1_7">Indexer::end_CI_loop</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> {</span>
                    <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1] =</span>
                        <span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">CI</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">);</span>
                    <span class="identifier">lpos</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_startpos</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1]; </span><span class="comment"> Back round loop</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
            <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_5"></a><b>&#167;6.1.5.  </b>It can happen that a section loop, at least, is empty:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Skip line if inside an empty loop</span> <span class="cwebmacronumber">6.1.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">rstl</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1; </span><span class="identifier">rstl</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">rstl</span><span class="plain">--)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="identifier">stack_pointer</span><span class="plain">-1] == </span><span class="constant">SECTION_LEVEL</span><span class="plain">) {</span>
                <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">SI</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">SI</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">) ==</span>
                    <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1])</span>
                    <span class="reserved">goto</span><span class="plain"> </span><span class="identifier">CYCLE</span><span class="plain">;</span>
            <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_6"></a><b>&#167;6.1.6.  </b>If called with level <code class="display"><span class="extract">CHAPTER_LEVEL</span></code>, this returns the topmost chapter number
on the stack; and similarly for <code class="display"><span class="extract">SECTION_LEVEL</span></code>.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">CHAPTER_LEVEL</span><span class="plain"> </span><span class="constant">1</span>
    <span class="definitionkeyword">define</span> <span class="constant">SECTION_LEVEL</span><span class="plain"> </span><span class="constant">2</span>
</pre>

<pre class="display">
    <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="functiontext">Indexer::heading_topmost_on_stack<button class="popup" onclick="togglePopup('usagePopup79')">...<span class="popuptext" id="usagePopup79">Usage of <b>Indexer::heading_topmost_on_stack</b>:<br><a href="#SP6_1_3">&#167;6.1.3</a>, <a href="#SP6_1_8_7">&#167;6.1.8.7</a>, <a href="#SP6_1_8_8">&#167;6.1.8.8</a></span></button></span><span class="plain">(</span><span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">level</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">rstl</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">-1; </span><span class="identifier">rstl</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">rstl</span><span class="plain">--)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">rstl</span><span class="plain">] == </span><span class="identifier">level</span><span class="plain">)</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">rstl</span><span class="plain">];</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6_1_7"></a><b>&#167;6.1.7.  </b>This is the code for starting a loop, which stacks up the details, and
similarly for ending it by popping them again:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::start_CI_loop<button class="popup" onclick="togglePopup('usagePopup80')">...<span class="popuptext" id="usagePopup80">Usage of <b>Indexer::start_CI_loop</b>:<br><a href="#SP6_1_2">&#167;6.1.2</a>, <a href="#SP6_1_3">&#167;6.1.3</a></span></button></span><span class="plain">(</span><span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">level</span><span class="plain">,</span>
        <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain">, </span><span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">to</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">pos</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain"> &lt; </span><span class="constant">CI_STACK_CAPACITY</span><span class="plain">) {</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_level</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">] = </span><span class="identifier">level</span><span class="plain">;</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_variable</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">] = </span><span class="identifier">from</span><span class="plain">;</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_threshold</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="identifier">stack_pointer</span><span class="plain">] = </span><span class="identifier">to</span><span class="plain">;</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">repeat_stack_startpos</span><span class="plain">[</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">++] = </span><span class="identifier">pos</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::end_CI_loop<button class="popup" onclick="togglePopup('usagePopup81')">...<span class="popuptext" id="usagePopup81">Usage of <b>Indexer::end_CI_loop</b>:<br><a href="#SP6_1_4">&#167;6.1.4</a></span></button></span><span class="plain">(</span><span class="reserved">index_engine_state</span><span class="plain"> *</span><span class="identifier">ies</span><span class="plain">) {</span>
        <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">stack_pointer</span><span class="plain">--;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6_1_8"></a><b>&#167;6.1.8. Variable substitutions. </b>We can now forget about this tiny stack machine: the one task left is to
take a line from the template, and make substitutions of variables into
its square-bracketed parts.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Make substitutions of square-bracketed variables in line</span> <span class="cwebmacronumber">6.1.8</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">slen</span><span class="plain">, </span><span class="identifier">spos</span><span class="plain">;</span>
        <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">spos</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP3">Regexp::find_expansion</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="character">'['</span><span class="plain">, </span><span class="character">'['</span><span class="plain">, </span><span class="character">']'</span><span class="plain">, </span><span class="character">']'</span><span class="plain">, &amp;</span><span class="identifier">slen</span><span class="plain">)) &gt;= </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">left_part</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">varname</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">right_part</span><span class="plain">);</span>

            <span class="functiontext"><a href="4-sm.html#SP25">Str::substr</a></span><span class="plain">(</span><span class="identifier">left_part</span><span class="plain">, </span><span class="functiontext"><a href="4-sm.html#SP10">Str::start</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">), </span><span class="functiontext"><a href="4-sm.html#SP10">Str::at</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">spos</span><span class="plain">));</span>
            <span class="functiontext"><a href="4-sm.html#SP25">Str::substr</a></span><span class="plain">(</span><span class="identifier">varname</span><span class="plain">, </span><span class="functiontext"><a href="4-sm.html#SP10">Str::at</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">spos</span><span class="plain">+2), </span><span class="functiontext"><a href="4-sm.html#SP10">Str::at</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">spos</span><span class="plain">+</span><span class="identifier">slen</span><span class="plain">-2));</span>
            <span class="functiontext"><a href="4-sm.html#SP25">Str::substr</a></span><span class="plain">(</span><span class="identifier">right_part</span><span class="plain">, </span><span class="functiontext"><a href="4-sm.html#SP10">Str::at</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="identifier">spos</span><span class="plain">+</span><span class="identifier">slen</span><span class="plain">), </span><span class="functiontext"><a href="4-sm.html#SP10">Str::end</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">));</span>

            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">);</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="8-bdfw.html#SP6">Bibliographic::data_exists</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute any bibliographic datum named</span> <span class="cwebmacronumber">6.1.8.1</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Navigation"</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute Navigation</span> <span class="cwebmacronumber">6.1.8.2</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Breadcrumbs"</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute Breadcrumbs</span> <span class="cwebmacronumber">6.1.8.3</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Plugins"</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute Plugins</span> <span class="cwebmacronumber">6.1.8.4</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Modules"</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute Modules</span> <span class="cwebmacronumber">6.1.8.5</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Complete (%c+)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">detail</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a detail about the complete PDF</span> <span class="cwebmacronumber">6.1.8.6</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Chapter (%c+)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">detail</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a Chapter</span> <span class="cwebmacronumber">6.1.8.7</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Section (%c+)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">detail</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a Section</span> <span class="cwebmacronumber">6.1.8.8</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Docs"</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Substitute a Docs</span> <span class="cwebmacronumber">6.1.8.9</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"URL \"(%c+)\""</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">link_text</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a URL</span> <span class="cwebmacronumber">6.1.8.10</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Link \"(%c+)\""</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">link_text</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a Link</span> <span class="cwebmacronumber">6.1.8.11</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Menu \"(%c+)\""</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">menu_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                &lt;<span class="cwebmacro">Substitute a Menu</span> <span class="cwebmacronumber">6.1.8.12</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Item \"(%c+)\""</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">item_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">icon_text</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
                &lt;<span class="cwebmacro">Look for icon text</span> <span class="cwebmacronumber">6.1.8.13</span>&gt;<span class="plain">;</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">link_text</span><span class="plain"> = </span><span class="identifier">item_name</span><span class="plain">;</span>
                &lt;<span class="cwebmacro">Substitute a member Item</span> <span class="cwebmacronumber">6.1.8.14</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Item \"(%c+)\" -&gt; (%c+)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">item_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">link_text</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1];</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">icon_text</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
                &lt;<span class="cwebmacro">Look for icon text</span> <span class="cwebmacronumber">6.1.8.13</span>&gt;<span class="plain">;</span>
                &lt;<span class="cwebmacro">Substitute a general Item</span> <span class="cwebmacronumber">6.1.8.15</span>&gt;<span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%i+%c*"</span><span class="plain">))</span>
                    <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Warning: unable to resolve command '%S'\n"</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="functiontext"><a href="4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">tl</span><span class="plain">, </span><span class="string">"%S%S%S"</span><span class="plain">, </span><span class="identifier">left_part</span><span class="plain">, </span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">right_part</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">left_part</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">varname</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">right_part</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_1"></a><b>&#167;6.1.8.1.  </b>This is why, for instance, <code class="display"><span class="extract">[[Author]]</span></code> is replaced by the author's name:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute any bibliographic datum named</span> <span class="cwebmacronumber">6.1.8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="functiontext"><a href="8-bdfw.html#SP6">Bibliographic::get_datum</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_2"></a><b>&#167;6.1.8.2.  </b><code class="display"><span class="extract">[[Navigation]]</span></code> substitutes to the content of the sidebar navigation file;
this will recursively call the Indexer, in fact.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute Navigation</span> <span class="cwebmacronumber">6.1.8.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_file</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-tf.html#SP1">TextFiles::exists</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_file</span><span class="plain">))</span>
                <span class="functiontext"><a href="#SP3">Indexer::incorporate_template</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">restrict_to_range</span><span class="plain">,</span>
                    <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_file</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
            <span class="reserved">else</span>
                <span class="functiontext"><a href="3-em.html#SP2">Errors::fatal_with_file</a></span><span class="plain">(</span><span class="string">"unable to find navigation file"</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_file</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Warning: no sidebar links will be generated, as -navigation is unset"</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_3"></a><b>&#167;6.1.8.3.  </b>A trail of breadcrumbs, used for overhead navigation in web pages.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute Breadcrumbs</span> <span class="cwebmacronumber">6.1.8.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="6-cln.html#SP6">Colonies::drop_initial_breadcrumbs</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">(),</span>
            <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">crumbs</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_4"></a><b>&#167;6.1.8.4.  </b><code class="display"><span class="extract">[[Plugins]]</span></code> here expands to material needed by any plugins required
by the weave ies-&gt;nav_pattern itself; it doesn't include optional extras for a
specific page because, of course, the Indexer is used for cover sheets and
not pages. (Except for navigation purposes, and navigation files should never
use this.)
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute Plugins</span> <span class="cwebmacronumber">6.1.8.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">weave_plugin</span><span class="plain"> *</span><span class="identifier">wp</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">wp</span><span class="plain">, </span><span class="reserved">weave_plugin</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">-&gt;</span><span class="element">plugins</span><span class="plain">)</span>
            <span class="functiontext"><a href="5-wp.html#SP3">WeavePlugins::include</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">, </span><span class="identifier">wp</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_5"></a><b>&#167;6.1.8.5.  </b>A list of all modules in the current web.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute Modules</span> <span class="cwebmacronumber">6.1.8.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">module</span><span class="plain"> *</span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">as_module</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext"><a href="2-llas.html#SP6">LinkedLists::len</a></span><span class="plain">(</span><span class="identifier">M</span><span class="plain">-&gt;</span><span class="element">dependencies</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
                <span class="string">"&lt;p class=\"purpose\"&gt;Together with the following imported module%s:\n"</span><span class="plain">,</span>
                <span class="plain">(</span><span class="identifier">L</span><span class="plain">==1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;ul class=\"chapterlist\"&gt;\n"</span><span class="plain">);</span>
            <span class="functiontext"><a href="#SP7">Indexer::list_module</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">for_web</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">as_module</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/ul&gt;\n"</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_6"></a><b>&#167;6.1.8.6.  </b>We store little about the complete-web-in-one-file PDF:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a detail about the complete PDF</span> <span class="cwebmacronumber">6.1.8.6</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">swarm_leader</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="5-fm.html#SP36">Formats::substitute_post_processing_data</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
                <span class="identifier">swarm_leader</span><span class="plain">, </span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S for complete web"</span><span class="plain">, </span><span class="identifier">detail</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_7"></a><b>&#167;6.1.8.7.  </b>And here for Chapters:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a Chapter</span> <span class="cwebmacronumber">6.1.8.7</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span>
            <span class="functiontext"><a href="#SP6_1_6">Indexer::heading_topmost_on_stack</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="constant">CHAPTER_LEVEL</span><span class="plain">), </span><span class="reserved">chapter</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-em.html#SP6">Errors::at_position</a></span><span class="plain">(</span><span class="string">"no chapter is currently selected"</span><span class="plain">,</span>
                <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">errors_at</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Substitute a detail about the currently selected Chapter</span> <span class="cwebmacronumber">6.1.8.7.1</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_7_1"></a><b>&#167;6.1.8.7.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a detail about the currently selected Chapter</span> <span class="cwebmacronumber">6.1.8.7.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Title"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_title</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Code"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_range</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Purpose"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">rubric</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="5-fm.html#SP36">Formats::substitute_post_processing_data</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
            <span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">ch_weave</span><span class="plain">, </span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">)) {</span>
            <span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S for %S"</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">ch_title</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8_7">&#167;6.1.8.7</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_8"></a><b>&#167;6.1.8.8.  </b>And this is a very similar construction for Sections.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a Section</span> <span class="cwebmacronumber">6.1.8.8</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain"> = </span><span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span>
            <span class="functiontext"><a href="#SP6_1_6">Indexer::heading_topmost_on_stack</a></span><span class="plain">(</span><span class="identifier">ies</span><span class="plain">, </span><span class="constant">SECTION_LEVEL</span><span class="plain">), </span><span class="reserved">section</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-em.html#SP6">Errors::at_position</a></span><span class="plain">(</span><span class="string">"no section is currently selected"</span><span class="plain">,</span>
                <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">errors_at</span><span class="plain">, </span><span class="identifier">lpos</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Substitute a detail about the currently selected Section</span> <span class="cwebmacronumber">6.1.8.8.1</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_8_1"></a><b>&#167;6.1.8.8.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a detail about the currently selected Section</span> <span class="cwebmacronumber">6.1.8.8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Title"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_title</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Purpose"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_purpose</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Code"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_range</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Lines"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%d"</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_extent</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Source"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%f"</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">source_file_for_section</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Page"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="6-cln.html#SP11">Colonies::section_URL</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Paragraphs"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%d"</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_paragraphs</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP21">Str::eq_wide_string</a></span><span class="plain">(</span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Mean"</span><span class="plain">)) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">denom</span><span class="plain"> = </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_paragraphs</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">denom</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">denom</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%d"</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_extent</span><span class="plain">/</span><span class="identifier">denom</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="5-fm.html#SP36">Formats::substitute_post_processing_data</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
            <span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">sect_weave</span><span class="plain">, </span><span class="identifier">detail</span><span class="plain">, </span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">nav_pattern</span><span class="plain">)) {</span>
            <span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S for %S"</span><span class="plain">, </span><span class="identifier">varname</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">md</span><span class="plain">-&gt;</span><span class="element">sect_title</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8_8">&#167;6.1.8.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_9"></a><b>&#167;6.1.8.9.  </b>These commands are all used in constructing relative URLs, especially for
navigation purposes.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a Docs</span> <span class="cwebmacronumber">6.1.8.9</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="3-pth.html#SP8">Pathnames::relative_URL</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
            <span class="functiontext"><a href="3-fln.html#SP6">Filenames::get_path_to</a></span><span class="plain">(</span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">()),</span>
            <span class="functiontext"><a href="3-pth.html#SP5">Pathnames::from_text</a></span><span class="plain">(</span><span class="functiontext"><a href="6-cln.html#SP9">Colonies::home</a></span><span class="plain">()));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_10"></a><b>&#167;6.1.8.10.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a URL</span> <span class="cwebmacronumber">6.1.8.10</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="3-pth.html#SP8">Pathnames::relative_URL</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
            <span class="functiontext"><a href="3-fln.html#SP6">Filenames::get_path_to</a></span><span class="plain">(</span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">()),</span>
            <span class="functiontext"><a href="3-pth.html#SP5">Pathnames::from_text</a></span><span class="plain">(</span><span class="identifier">link_text</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_11"></a><b>&#167;6.1.8.11.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a Link</span> <span class="cwebmacronumber">6.1.8.11</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;a href=\""</span><span class="plain">);</span>
        <span class="functiontext"><a href="6-cln.html#SP11">Colonies::reference_URL</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="identifier">link_text</span><span class="plain">, </span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">());</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"\"&gt;"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_12"></a><b>&#167;6.1.8.12.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a Menu</span> <span class="cwebmacronumber">6.1.8.12</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/ul&gt;"</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;h2&gt;%S&lt;/h2&gt;&lt;ul&gt;"</span><span class="plain">, </span><span class="identifier">menu_name</span><span class="plain">);</span>
        <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_13"></a><b>&#167;6.1.8.13.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Look for icon text</span> <span class="cwebmacronumber">6.1.8.13</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">item_name</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;(%i+.%i+)&gt; *(%c*)"</span><span class="plain">)) {</span>
            <span class="identifier">icon_text</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            <span class="identifier">item_name</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">item_name</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?) *&lt;(%i+.%i+)&gt;"</span><span class="plain">)) {</span>
            <span class="identifier">icon_text</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>
            <span class="identifier">item_name</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a> (twice).</p>

<p class="inwebparagraph"><a id="SP6_1_8_14"></a><b>&#167;6.1.8.14.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a member Item</span> <span class="cwebmacronumber">6.1.8.14</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
        <span class="functiontext"><a href="6-cln.html#SP11">Colonies::reference_URL</a></span><span class="plain">(</span><span class="identifier">url</span><span class="plain">, </span><span class="identifier">link_text</span><span class="plain">, </span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">());</span>
        &lt;<span class="cwebmacro">Substitute an item at this URL</span> <span class="cwebmacronumber">6.1.8.14.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_15"></a><b>&#167;6.1.8.15.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute a general Item</span> <span class="cwebmacronumber">6.1.8.15</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
        <span class="functiontext"><a href="6-cln.html#SP11">Colonies::link_URL</a></span><span class="plain">(</span><span class="identifier">url</span><span class="plain">, </span><span class="identifier">link_text</span><span class="plain">, </span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">());</span>
        &lt;<span class="cwebmacro">Substitute an item at this URL</span> <span class="cwebmacronumber">6.1.8.14.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8">&#167;6.1.8</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_14_1"></a><b>&#167;6.1.8.14.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute an item at this URL</span> <span class="cwebmacronumber">6.1.8.14.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;ul&gt;"</span><span class="plain">);</span>
        <span class="identifier">ies</span><span class="plain">-&gt;</span><span class="element">inside_navigation_submenu</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;li&gt;"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">url</span><span class="plain">, </span><span class="functiontext"><a href="3-fln.html#SP7">Filenames::get_leafname</a></span><span class="plain">(</span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">()))) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;span class=\"unlink\"&gt;"</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Substitute icon and name</span> <span class="cwebmacronumber">6.1.8.14.1.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/span&gt;"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">url</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"index.html"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;a href=\"%S\"&gt;"</span><span class="plain">, </span><span class="identifier">url</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;span class=\"selectedlink\"&gt;"</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Substitute icon and name</span> <span class="cwebmacronumber">6.1.8.14.1.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/span&gt;"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/a&gt;"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;a href=\"%S\"&gt;"</span><span class="plain">, </span><span class="identifier">url</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Substitute icon and name</span> <span class="cwebmacronumber">6.1.8.14.1.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/a&gt;"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;/li&gt;"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8_14">&#167;6.1.8.14</a>, <a href="#SP6_1_8_15">&#167;6.1.8.15</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_8_14_1_1"></a><b>&#167;6.1.8.14.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute icon and name</span> <span class="cwebmacronumber">6.1.8.14.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">icon_text</span><span class="plain">) &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"&lt;img src=\""</span><span class="plain">);</span>
            <span class="functiontext"><a href="3-pth.html#SP8">Pathnames::relative_URL</a></span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">,</span>
                <span class="functiontext"><a href="3-fln.html#SP6">Filenames::get_path_to</a></span><span class="plain">(</span><span class="functiontext"><a href="#SP9">Indexer::current_file</a></span><span class="plain">()),</span>
                <span class="functiontext"><a href="3-pth.html#SP5">Pathnames::from_text</a></span><span class="plain">(</span><span class="functiontext"><a href="6-cln.html#SP9">Colonies::home</a></span><span class="plain">()));</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S\" height=18&gt; "</span><span class="plain">, </span><span class="identifier">icon_text</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">substituted</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">item_name</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1_8_14_1">&#167;6.1.8.14.1</a> (three times).</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::list_module<button class="popup" onclick="togglePopup('usagePopup82')">...<span class="popuptext" id="usagePopup82">Usage of <b>Indexer::list_module</b>:<br><a href="#SP6_1_8_5">&#167;6.1.8.5</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">module</span><span class="plain"> *</span><span class="identifier">M</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">list_this</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">list_this</span><span class="plain">) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;li&gt;&lt;p&gt;%S - "</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">-&gt;</span><span class="element">module_name</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">, </span><span class="string">"%p"</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">-&gt;</span><span class="element">module_location</span><span class="plain">);</span>
            <span class="functiontext"><a href="6-rw.html#SP8">Readme::write_var</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">url</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Purpose"</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">url</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/p&gt;&lt;/li&gt;"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">module</span><span class="plain"> *</span><span class="identifier">N</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">module</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">-&gt;</span><span class="element">dependencies</span><span class="plain">)</span>
            <span class="functiontext"><a href="#SP7">Indexer::list_module</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">N</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Transcribing CSS. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::transcribe_CSS<button class="popup" onclick="togglePopup('usagePopup83')">...<span class="popuptext" id="usagePopup83">Usage of <b>Indexer::transcribe_CSS</b>:<br><a href="#SP2">&#167;2</a>, <a href="#SP6_1">&#167;6.1</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CSS_file</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;style type=\"text/css\"&gt;\n"</span><span class="plain">);</span>
        <span class="functiontext"><a href="4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">CSS_file</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open CSS file"</span><span class="plain">,</span>
            <span class="constant">TRUE</span><span class="plain">, </span><span class="functiontext"><a href="#SP8">Indexer::copy_CSS</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\n&lt;/style&gt;\n"</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::copy_CSS<button class="popup" onclick="togglePopup('usagePopup84')">...<span class="popuptext" id="usagePopup84">Usage of <b>Indexer::copy_CSS</b>:<br>none</span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">X</span><span class="plain">) {</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = (</span><span class="reserved">text_stream</span><span class="plain"> *) </span><span class="identifier">X</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\n"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Tracking the file being written to. </b></p>

<pre class="display">
    <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">file_being_woven</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">filename</span><span class="plain"> *</span><span class="functiontext">Indexer::current_file<button class="popup" onclick="togglePopup('usagePopup85')">...<span class="popuptext" id="usagePopup85">Usage of <b>Indexer::current_file</b>:<br><a href="#SP6">&#167;6</a>, <a href="#SP6_1_8_3">&#167;6.1.8.3</a>, <a href="#SP6_1_8_9">&#167;6.1.8.9</a>, <a href="#SP6_1_8_10">&#167;6.1.8.10</a>, <a href="#SP6_1_8_11">&#167;6.1.8.11</a>, <a href="#SP6_1_8_14">&#167;6.1.8.14</a>, <a href="#SP6_1_8_15">&#167;6.1.8.15</a>, <a href="#SP6_1_8_14_1">&#167;6.1.8.14.1</a>, <a href="#SP6_1_8_14_1_1">&#167;6.1.8.14.1.1</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">file_being_woven</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Indexer::set_current_file<button class="popup" onclick="togglePopup('usagePopup86')">...<span class="popuptext" id="usagePopup86">Usage of <b>Indexer::set_current_file</b>:<br><a href="#SP6">&#167;6</a>, The Swarm - <a href="3-ts.html#SP4">&#167;4</a><br>The Weaver - <a href="3-tw.html#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="identifier">file_being_woven</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="3-ts.html">Back to 'The Swarm'</a></li><li><a href="3-tw.html">Continue with 'The Weaver'</a></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

