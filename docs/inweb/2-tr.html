<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/bd</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../inweb/index.html">inweb</a></li>
</ul>
<h2>Foundation</h2>
<ul>
<li><a href="../foundation-module/index.html">foundation-module</a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of '2/tr' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="index.html">inweb 7</a></li><li><a href="index.html#2">Chapter 2: Parsing a Web</a></li><li><b>The Reader</b></li></ul><p class="purpose">To read the Contents section of the web, and through that each of the other sections in turn, and to collate all of this material.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Web storage</a></li><li><a href="#SP5">&#167;5. Chapters and sections</a></li><li><a href="#SP7">&#167;7. Reading the contents page</a></li><li><a href="#SP10">&#167;10. Reading source files</a></li><li><a href="#SP11">&#167;11. Looking up chapters and sections</a></li><li><a href="#SP13">&#167;13. Ranges and containment</a></li><li><a href="#SP14">&#167;14. Tangle targets</a></li><li><a href="#SP17">&#167;17. Additional header files</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Web storage. </b>There's normally only one web read in during a single run of Inweb, but
this might change if we ever add batch-processing in future. A web is a set
of chapters each of which is a set of sections; webs which don't obviously
divide into chapters will be called "unchaptered", though in fact they do
have a single chapter, called simply "Sections" (and with range "S").
</p>

<p class="inwebparagraph">The program expressed by a web is output, or "tangled", to a number of
stand-alone files called "tangle targets". By default there is just one
of these.
</p>

<p class="inwebparagraph">We read the complete literate source of the web into memory, which is
profligate, but saves time. Most of the lines come straight from the
source files, but a few chapter heading lines are inserted if this is a
multi-chapter web.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">web</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">path_to_web</span><span class="plain">; </span>    <span class="comment">relative to the current working directory</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">single_file</span><span class="plain">; </span>    <span class="comment">relative to the current working directory</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">default_syntax</span><span class="plain">; </span>    <span class="comment">which version syntax the sections will have</span>

        <span class="comment">convenient statistics</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_lines</span><span class="plain">; </span>    <span class="comment">total lines in literate source, excluding contents</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_paragraphs</span><span class="plain">; </span>    <span class="comment">this will be at least 1</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_sections</span><span class="plain">; </span>    <span class="comment">again, excluding contents: it will eventually be at least 1</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_chapters</span><span class="plain">; </span>    <span class="comment">this will be at least 1</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">chaptered</span><span class="plain">; </span>    <span class="comment">has the author explicitly divided it into named chapters?</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">analysed</span><span class="plain">; </span>    <span class="comment">has this been scanned for function usage and such?</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">bibliographic_data</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">bibliographic_datum</span></code>: key-value pairs for title and such</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">main_language</span><span class="plain">; </span>    <span class="comment">in which most of the sections are written</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">tangle_targets</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">tangle_target</span></code></span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">chapters</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">chapter</span></code> (including Sections, Preliminaries, etc.)</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">headers</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">filename</span></code>: additional header files</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">c_structures</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">c_structure</span></code>: used only for C-like languages</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">module</span><span class="plain"> *</span><span class="identifier">as_module</span><span class="plain">; </span>    <span class="comment">the root of a small dependency graph</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">as_ebook</span><span class="plain">; </span>    <span class="comment">when being woven to an ebook</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">redirect_weaves_to</span><span class="plain">; </span>    <span class="comment">ditto</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">web</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure web is accessed in 1/pc, 1/ptt, 2/bd, 2/mdl, 2/tp, 2/pn, 3/ta, 3/ts, 3/ti, 3/tw, 3/tt, 4/cl, 4/is, 5/hf, 6/mkf and here.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b></p>


<pre class="display">
    <span class="reserved">web</span><span class="plain"> *</span><span class="functiontext">Reader::load_web</span><span class="plain">(</span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">alt_F</span><span class="plain">, </span><span class="reserved">module_search</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">verbosely</span><span class="plain">,</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">inweb_mode</span><span class="plain">, </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">redirection</span><span class="plain">) {</span>
        <span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">web</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain"> = </span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;single_file</span><span class="plain"> = </span><span class="identifier">alt_F</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">alt_F</span><span class="plain">) </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain"> = </span><span class="functiontext">Filenames::get_path_to</span><span class="plain">(</span><span class="identifier">alt_F</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;headers</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;c_structures</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">c_structure</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;bibliographic_data</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">bibliographic_datum</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;tangle_targets</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">tangle_target</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_lines</span><span class="plain"> = 0; </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_sections</span><span class="plain"> = 0; </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_chapters</span><span class="plain"> = 0; </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_paragraphs</span><span class="plain"> = 0;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;analysed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;as_ebook</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;redirect_weaves_to</span><span class="plain"> = </span><span class="identifier">redirection</span><span class="plain">;</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;as_module</span><span class="plain"> = </span><span class="functiontext">Modules::main_module</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">);</span>
        <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain"> = </span><span class="identifier">default_inweb_syntax</span><span class="plain">;</span>
        <span class="functiontext">Bibliographic::initialise_data</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">);</span>
        <span class="functiontext">Reader::add_tangle_target</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="functiontext">Languages::default</span><span class="plain">()); </span>    <span class="comment">the bulk of the web is automatically a target</span>
        <span class="functiontext">Reader::read_contents_page</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">verbosely</span><span class="plain">);</span>
        <span class="functiontext">Parser::parse_web</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">inweb_mode</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_sections</span><span class="plain"> == 1) {</span>
            <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">FIRST_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">);</span>
            <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain"> = </span><span class="identifier">FIRST_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain">);</span>
            <span class="identifier">S</span><span class="plain">-</span><span class="element">&gt;is_a_singleton</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">W</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::load_web is used in 1/pc (<a href="1-pc.html#SP7">&#167;7</a>).</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>We abstract these in order to be able to respond well to their not existing:
</p>


<pre class="display">
    <span class="reserved">pathname</span><span class="plain"> *</span><span class="functiontext">Reader::woven_folder</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">) {</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Woven"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_path</span><span class="plain">(</span><span class="string">"unable to create Woven subdirectory"</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">P</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">pathname</span><span class="plain"> *</span><span class="functiontext">Reader::tangled_folder</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">) {</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Tangled"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_path</span><span class="plain">(</span><span class="string">"unable to create Tangled subdirectory"</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">P</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::woven_folder is used in 1/ptt (<a href="1-ptt.html#SP7">&#167;7</a>), 3/ts (<a href="3-ts.html#SP2_2">&#167;2.2</a>), 3/ti (<a href="3-ti.html#SP5_4">&#167;5.4</a>), 5/hf (<a href="5-hf.html#SP27">&#167;27</a>).</p>

<p class="endnote">The function Reader::tangled_folder is used in 1/pc (<a href="1-pc.html#SP7_2_2">&#167;7.2.2</a>), 3/tt (<a href="3-tt.html#SP1_2">&#167;1.2</a>), 4/is (<a href="4-is.html#SP13">&#167;13</a>).</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>This really serves no purpose, but seems to boost morale.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::print_web_statistics</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">) {</span>
        <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"web \</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">: "</span><span class="plain">, </span><span class="functiontext">Bibliographic::get_datum</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Title"</span><span class="plain">));</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain">) </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%d chapter(s) : "</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_chapters</span><span class="plain">);</span>
        <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%d section(s) : %d paragraph(s) : %d line(s)\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
            <span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_sections</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_paragraphs</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;no_lines</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::print_web_statistics is used in 1/pc (<a href="1-pc.html#SP7_2">&#167;7.2</a>).</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Chapters and sections. </b>Each web contains a linked list of chapters, in reading order:
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">chapter</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">ch_range</span><span class="plain">; </span>    <span class="comment">e.g., <code class="display"><span class="extract">P</span></code> for Preliminaries, <code class="display"><span class="extract">7</span></code> for Chapter 7, <code class="display"><span class="extract">C</span></code> for Appendix C</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">ch_title</span><span class="plain">; </span>    <span class="comment">e.g., "Chapter 3: Fresh Water Fish"</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">rubric</span><span class="plain">; </span>    <span class="comment">optional; without double-quotation marks</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">tangle_target</span><span class="plain"> *</span><span class="identifier">ch_target</span><span class="plain">; </span>    <span class="comment"><code class="display"><span class="extract">NULL</span></code> unless this chapter produces a tangle of its own</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">weave_target</span><span class="plain"> *</span><span class="identifier">ch_weave</span><span class="plain">; </span>    <span class="comment"><code class="display"><span class="extract">NULL</span></code> unless this chapter produces a weave of its own</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">ch_language</span><span class="plain">; </span>    <span class="comment">in which most of the sections are written</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">titling_line_inserted</span><span class="plain">; </span>    <span class="comment">has an interleaved chapter heading been added yet?</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">ch_extent</span><span class="plain">; </span>    <span class="comment">total number of lines in the sections of this chapter</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">sections</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">section</span></code>: the content of this chapter</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">owning_web</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">imported</span><span class="plain">; </span>    <span class="comment">from a different web?</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">chapter</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure chapter is accessed in 1/pc, 2/tp, 2/pn, 3/ta, 3/ts, 3/ti, 3/tw, 3/tt, 5/ptf, 5/tf, 5/hf and here.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>Each chapter contains a linked list of sections, in reading order:
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">section</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range</span><span class="plain">; </span>    <span class="comment">e.g., "9/tfto"</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">sect_title</span><span class="plain">; </span>    <span class="comment">e.g., "Program Control"</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">sect_namespace</span><span class="plain">; </span>    <span class="comment">e.g., "Text::Languages::"</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">sect_purpose</span><span class="plain">; </span>    <span class="comment">e.g., "To manage the zoo, and feed all penguins"</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">using_syntax</span><span class="plain">; </span>    <span class="comment">which syntax the web is written in</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">barred</span><span class="plain">; </span>    <span class="comment">if version 1 syntax, contains a dividing bar?</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">is_a_singleton</span><span class="plain">; </span>    <span class="comment">is this the only section in its entire web?</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">source_file_for_section</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">paused_until_at</span><span class="plain">; </span>    <span class="comment">ignore the top half of the file, until the first <code class="display"><span class="extract">@</span></code> sign</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">tangle_target</span><span class="plain"> *</span><span class="identifier">sect_target</span><span class="plain">; </span>    <span class="comment"><code class="display"><span class="extract">NULL</span></code> unless this section produces a tangle of its own</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">weave_target</span><span class="plain"> *</span><span class="identifier">sect_weave</span><span class="plain">; </span>    <span class="comment"><code class="display"><span class="extract">NULL</span></code> unless this section produces a weave of its own</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">sect_language</span><span class="plain">; </span>    <span class="comment">in which this section is written</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sect_extent</span><span class="plain">; </span>    <span class="comment">total number of lines in this section</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">source_line</span><span class="plain"> *</span><span class="identifier">first_line</span><span class="plain">; </span>    <span class="comment">for efficiency's sake not held as a <code class="display"><span class="extract">linked_list</span></code>,</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">source_line</span><span class="plain"> *</span><span class="identifier">last_line</span><span class="plain">; </span>    <span class="comment">but that's what it is, all the same</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sect_paragraphs</span><span class="plain">; </span>    <span class="comment">total number of paragraphs in this section</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">paragraphs</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">paragraph</span></code>: the content of this section</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">theme_tag</span><span class="plain"> *</span><span class="identifier">tag_with</span><span class="plain">; </span>    <span class="comment">automatically tag paras in this section thus</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">macros</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">para_macro</span></code>: those defined in this section</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">owning_chapter</span><span class="plain">;</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">scratch_flag</span><span class="plain">; </span>    <span class="comment">temporary workspace</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">printed_number</span><span class="plain">; </span>    <span class="comment">temporary again: sometimes used in weaving</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">erroneous_interface</span><span class="plain">; </span>    <span class="comment">problem with Interface declarations</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">section</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure section is accessed in 1/pc, 2/tp, 2/pm, 2/tgs, 2/pn, 3/ta, 3/ts, 3/ti, 3/tw, 3/tt, 4/pl, 4/cl, 4/is, 5/ptf, 5/tf, 5/hf and here.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Reading the contents page. </b>Making the web begins by reading the contents section, which really isn't a
section at all (and perhaps we shouldn't pretend that it is by the use of the
<code class="display"><span class="extract">.w</span></code> file extension, but we probably want it to have the same file extension,
and its syntax is chosen so that syntax-colouring for regular sections doesn't
make it look odd). When the word "section" is used in the Inweb code, it
almost always means "section other than the contents".
</p>

<p class="inwebparagraph">Because a contents page can, by importing a module, cause a further contents
page to be read, we set this up as a recursion:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::read_contents_page</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">module_search</span><span class="plain"> *</span><span class="identifier">import_path</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">verbosely</span><span class="plain">) {</span>
        <span class="functiontext">Reader::read_contents_page_from</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">, </span><span class="identifier">import_path</span><span class="plain">, </span><span class="identifier">verbosely</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="functiontext">Bibliographic::check_required_data</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::read_contents_page is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>We then run through an individual contents page line by line, using the
following slate of variables to keep track of where we are.
</p>

<p class="inwebparagraph">With a single-file web, the "contents section" doesn't exist as a file in its
own right: instead, it's the top few lines of the single file. We handle that
by halting at the junction point.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">reader_state</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">current_web</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">contents_filename</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">in_biblio</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">in_purpose</span><span class="plain">; </span>    <span class="comment">Reading the bit just after the new chapter?</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">chapter_being_scanned</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">chapter_folder_name</span><span class="plain">; </span>    <span class="comment">Where sections in the current chapter live</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">titling_line_to_insert</span><span class="plain">; </span>    <span class="comment">To be inserted automagically</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">path_to</span><span class="plain">; </span>    <span class="comment">Where web material is being read from</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">module_search</span><span class="plain"> *</span><span class="identifier">import_from</span><span class="plain">; </span>    <span class="comment">Where imported webs are</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">scan_verbosely</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">main_web_not_module</span><span class="plain">; </span>    <span class="comment">Reading the original web, or an included one?</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">halt_at_at</span><span class="plain">; </span>    <span class="comment">Used for reading contents pages of single-file webs</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">halted</span><span class="plain">; </span>    <span class="comment">Set when such a halt has occurred</span>
    <span class="plain">} </span><span class="reserved">reader_state</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::read_contents_page_from</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">module_search</span><span class="plain"> *</span><span class="identifier">import_path</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">verbosely</span><span class="plain">, </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">path</span><span class="plain">) {</span>
        <span class="reserved">reader_state</span><span class="plain"> </span><span class="identifier">RS</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Initialise the reader state</span> <span class="cwebmacronumber">8.1</span>&gt;<span class="plain">;</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cl</span><span class="plain"> = </span><span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">RS</span><span class="element">.contents_filename</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open contents file"</span><span class="plain">,</span>
            <span class="constant">TRUE</span><span class="plain">, </span><span class="functiontext">Reader::read_contents_line</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">RS</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">verbosely</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;single_file</span><span class="plain">) {</span>
                <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Read %d lines of contents part at top of file\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">cl</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Read contents section: 'Contents.w' (%d lines)\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">cl</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::read_contents_page_from is used in <a href="#SP7">&#167;7</a>, <a href="#SP9_3_3_2">&#167;9.3.3.2</a>.</p>

<p class="endnote">The structure reader_state is private to this section.</p>

<p class="inwebparagraph"><a id="SP8_1"></a><b>&#167;8.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Initialise the reader state</span> <span class="cwebmacronumber">8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">RS</span><span class="element">.current_web</span><span class="plain"> = </span><span class="identifier">W</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.in_biblio</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.in_purpose</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.chapter_being_scanned</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.chapter_folder_name</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="identifier">RS</span><span class="element">.titling_line_to_insert</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="identifier">RS</span><span class="element">.scan_verbosely</span><span class="plain"> = </span><span class="identifier">verbosely</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.path_to</span><span class="plain"> = </span><span class="identifier">path</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.import_from</span><span class="plain"> = </span><span class="identifier">import_path</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="element">.halted</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">path</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">path</span><span class="plain"> = </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain">;</span>
            <span class="identifier">RS</span><span class="element">.main_web_not_module</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">RS</span><span class="element">.main_web_not_module</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;single_file</span><span class="plain">) {</span>
            <span class="identifier">RS</span><span class="element">.contents_filename</span><span class="plain"> = </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;single_file</span><span class="plain">;</span>
            <span class="identifier">RS</span><span class="element">.halt_at_at</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">RS</span><span class="element">.contents_filename</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">path</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Contents.w"</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="element">.halt_at_at</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9.  </b>The contents section has a syntax quite different from all other sections,
and sets out bibliographic information about the web, the sections and their
organisation, and so on.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::read_contents_line</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">X</span><span class="plain">) {</span>
        <span class="reserved">reader_state</span><span class="plain"> *</span><span class="identifier">RS</span><span class="plain"> = (</span><span class="reserved">reader_state</span><span class="plain"> *) </span><span class="identifier">X</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;halted</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">begins_with_white_space</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Characters::is_whitespace</span><span class="plain">(</span><span class="functiontext">Str::get_first_char</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">)))</span>
            <span class="identifier">begins_with_white_space</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="functiontext">Str::trim_white_space</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>

        &lt;<span class="cwebmacro">Act immediately if the web syntax version is changed</span> <span class="cwebmacronumber">9.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">syntax</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain">;</span>

        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">filename_of_single_file_web</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;halt_at_at</span><span class="plain">) &amp;&amp; (</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, 0) == </span><span class="character">'@'</span><span class="plain">))</span>
            &lt;<span class="cwebmacro">Halt at this point in the single file, and make the rest of it a one-chaoter section</span> <span class="cwebmacronumber">9.2</span>&gt;<span class="plain">;</span>

        &lt;<span class="cwebmacro">Read regular contents material</span> <span class="cwebmacronumber">9.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::read_contents_line is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP9_1"></a><b>&#167;9.1.  </b>Since the web syntax version affects how the rest of the file is read, it's
no good simply to store this up for later: we have to change the web structure
immediately.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Act immediately if the web syntax version is changed</span> <span class="cwebmacronumber">9.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Web Syntax Version: 1"</span><span class="plain">))</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain"> = </span><span class="constant">V1_SYNTAX</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Web Syntax Version: 2"</span><span class="plain">))</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain"> = </span><span class="constant">V2_SYNTAX</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_2"></a><b>&#167;9.2.  </b>Suppose we're reading a single-file web, and we hit the first <code class="display"><span class="extract">@</span></code> marker.
The contents part has now ended, so we should halt scanning. But we also need
to give the web a single chapter ("Sections", range "S"), which contains a
single section ("All") consisting of the remainder of the single file.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Halt at this point in the single file, and make the rest of it a one-chaoter section</span> <span class="cwebmacronumber">9.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;halted</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">tangle_target</span><span class="plain"> *</span><span class="identifier">ind_target</span><span class="plain"> = </span><span class="functiontext">Tangler::primary_target</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">);</span>
        <span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">ind_language</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;main_language</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">new_chapter_range</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"S"</span><span class="plain">;</span>
        <span class="identifier">line</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"Sections"</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Create the new chapter with these details</span> <span class="cwebmacronumber">9.2.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">line</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"All"</span><span class="plain">;</span>
        <span class="identifier">filename_of_single_file_web</span><span class="plain"> = </span><span class="identifier">tfp</span><span class="plain">-</span><span class="element">&gt;text_file_filename</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Read about, and read in, a new section</span> <span class="cwebmacronumber">9.2.2</span>&gt;<span class="plain">;</span>
        <span class="reserved">return</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_3"></a><b>&#167;9.3.  </b>With those two complications out of the way, we now know that we're reading
a line of contents material. At the start of the contents, this will be a
series of bibliographic data values; then there's a blank line, and then
we're into the section listing.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read regular contents material</span> <span class="cwebmacronumber">9.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">) == 0) </span>&lt;<span class="cwebmacro">End bibliographic data here, at the blank line</span> <span class="cwebmacronumber">9.3.1</span>&gt;
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;in_biblio</span><span class="plain">) </span>&lt;<span class="cwebmacro">Read the bibliographic data block at the top</span> <span class="cwebmacronumber">9.3.2</span>&gt;
        <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read the roster of sections at the bottom</span> <span class="cwebmacronumber">9.3.3</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_1"></a><b>&#167;9.3.1.  </b>At this point we've gone through the bibliographic lines at the top of the
contents page, and are soon going to read in the sections. The language needs
to be known for that, so we'll set it now.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">End bibliographic data here, at the blank line</span> <span class="cwebmacronumber">9.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">pl</span><span class="plain"> =</span>
            <span class="functiontext">Languages::find_by_name</span><span class="plain">(</span>
                <span class="functiontext">Bibliographic::get_datum</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Language"</span><span class="plain">));</span>
        <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;main_language</span><span class="plain"> = </span><span class="identifier">pl</span><span class="plain">;</span>
        <span class="functiontext">Tangler::primary_target</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">)-</span><span class="element">&gt;tangle_language</span><span class="plain"> = </span><span class="identifier">pl</span><span class="plain">;</span>
        <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;in_biblio</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_2"></a><b>&#167;9.3.2.  </b>The bibliographic data gives lines in any order specifying values of
variables with fixed names; a blank line ends the block.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read the bibliographic data block at the top</span> <span class="cwebmacronumber">9.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;main_web_not_module</span><span class="plain">) {</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c+?): (%c+?) *"</span><span class="plain">)) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">key</span><span class="plain">);</span>
                <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">key</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">);</span>
                <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
                &lt;<span class="cwebmacro">Set bibliographic key-value pair</span> <span class="cwebmacronumber">9.3.2.1</span>&gt;<span class="plain">;</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">key</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"expected 'Setting: Value' but found '%S'"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
                <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_2_1"></a><b>&#167;9.3.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Set bibliographic key-value pair</span> <span class="cwebmacronumber">9.3.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Bibliographic::datum_can_be_declared</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Bibliographic::datum_on_or_off</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">)) {</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::ne_wide_string</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"On"</span><span class="plain">)) &amp;&amp; (</span><span class="functiontext">Str::ne_wide_string</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Off"</span><span class="plain">))) {</span>
                    <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                    <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"this setting must be 'On' or 'Off': %S"</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
                    <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
                    <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">);</span>
                    <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">value</span><span class="plain">, </span><span class="string">"Off"</span><span class="plain">);</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
            <span class="functiontext">Bibliographic::set_datum</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">, </span><span class="identifier">value</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"no such bibliographic datum: %S"</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
            <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_2">&#167;9.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_3"></a><b>&#167;9.3.3.  </b>In the bulk of the contents, we find indented lines for sections and
unindented ones for chapters.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read the roster of sections at the bottom</span> <span class="cwebmacronumber">9.3.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">begins_with_white_space</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get_first_char</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">) == </span><span class="character">'"'</span><span class="plain">) { </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;in_purpose</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">; </span><span class="functiontext">Str::delete_first_character</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">); }</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;in_purpose</span><span class="plain"> == </span><span class="constant">TRUE</span><span class="plain">) </span>&lt;<span class="cwebmacro">Record the purpose of the current chapter</span> <span class="cwebmacronumber">9.3.3.1</span>&gt;
            <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read about a new chapter</span> <span class="cwebmacronumber">9.3.3.2</span>&gt;<span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read about, and read in, a new section</span> <span class="cwebmacronumber">9.2.2</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_3_1"></a><b>&#167;9.3.3.1.  </b>After a declared chapter heading, subsequent lines form its purpose, until
we reach a closed quote: we then stop, but remove the quotation marks. Because
we like a spoonful of syntactic sugar on our porridge, that's why.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Record the purpose of the current chapter</span> <span class="cwebmacronumber">9.3.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">) &gt; 0) &amp;&amp; (</span><span class="functiontext">Str::get_last_char</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">) == </span><span class="character">'"'</span><span class="plain">)) {</span>
            <span class="functiontext">Str::truncate</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">)-1); </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;in_purpose</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain">) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">r</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain">-</span><span class="element">&gt;rubric</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">r</span><span class="plain">) &gt; 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">r</span><span class="plain">, </span><span class="string">" "</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">r</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_3">&#167;9.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_3_2"></a><b>&#167;9.3.3.2.  </b>The title tells us everything we need to know about a chapter:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read about a new chapter</span> <span class="cwebmacronumber">9.3.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">); </span>    <span class="comment">e.g., S, P, 1, 2, 3, A, B, ...</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">);</span>
        <span class="reserved">tangle_target</span><span class="plain"> *</span><span class="identifier">ind_target</span><span class="plain"> = </span><span class="functiontext">Tangler::primary_target</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">);</span>
        <span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">ind_language</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;main_language</span><span class="plain">;</span>

        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*%C) %(Independent(%c*)%)"</span><span class="plain">)) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title_alone</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0];</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">language_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1];</span>
            &lt;<span class="cwebmacro">Mark this chapter as an independent tangle target</span> <span class="cwebmacronumber">9.3.3.2.1</span>&gt;<span class="plain">;</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">title_alone</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">this_is_a_chapter</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Sections"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">, </span><span class="string">"S"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">, </span><span class="string">"Sections"</span><span class="plain">);</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">, </span><span class="string">"Sections.pdf"</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Preliminaries"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">, </span><span class="string">"P"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">, </span><span class="string">"Preliminaries"</span><span class="plain">);</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">, </span><span class="string">"%S."</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">, </span><span class="string">"Preliminaries.pdf"</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Manual"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">, </span><span class="string">"M"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">, </span><span class="string">"Manual"</span><span class="plain">);</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">, </span><span class="string">"%S."</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">, </span><span class="string">"Manual.pdf"</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Header: (%c+)"</span><span class="plain">)) {</span>
            <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;path_to</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain">;</span>
            <span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Headers"</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">HF</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="functiontext">Reader::add_imported_header</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">HF</span><span class="plain">);</span>
            <span class="identifier">this_is_a_chapter</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Import: (%c+)"</span><span class="plain">)) {</span>
            <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">imported</span><span class="plain"> = </span><span class="functiontext">Modules::find</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;import_from</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">imported</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"unable to find module: %S"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
                <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="reserved">int</span><span class="plain"> </span><span class="identifier">save_syntax</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain">;</span>
                <span class="functiontext">Reader::read_contents_page_from</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;import_from</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;scan_verbosely</span><span class="plain">, </span><span class="identifier">imported</span><span class="plain">);</span>
                <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;default_syntax</span><span class="plain"> = </span><span class="identifier">save_syntax</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="identifier">this_is_a_chapter</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Chapter (%d+): %c+"</span><span class="plain">)) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">n</span><span class="plain"> = </span><span class="functiontext">Str::atoi</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0], 0);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">, </span><span class="string">"%d"</span><span class="plain">, </span><span class="identifier">n</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">, </span><span class="string">"Chapter %d"</span><span class="plain">, </span><span class="identifier">n</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">, </span><span class="string">"%S."</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">, </span><span class="string">"Chapter-%d.pdf"</span><span class="plain">, </span><span class="identifier">n</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Appendix (%c): %c+"</span><span class="plain">)) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">letter</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0];</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">, </span><span class="identifier">letter</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">, </span><span class="string">"Appendix %S"</span><span class="plain">, </span><span class="identifier">letter</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">, </span><span class="string">"%S."</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">, </span><span class="string">"Appendix-%S.pdf"</span><span class="plain">, </span><span class="identifier">letter</span><span class="plain">);</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chaptered</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"segment not understood: %S"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
            <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="constant">STDERR</span><span class="plain">, </span><span class="string">"(Must be 'Chapter &lt;number&gt;: Title', "</span>
                <span class="string">"'Appendix &lt;letter A to O&gt;: Title',\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="constant">STDERR</span><span class="plain">, </span><span class="string">"'Manual', 'Preliminaries' or 'Sections')\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">this_is_a_chapter</span><span class="plain">) </span>&lt;<span class="cwebmacro">Create the new chapter with these details</span> <span class="cwebmacronumber">9.2.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">pdf_leafname</span><span class="plain">);</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_3">&#167;9.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_3_2_1"></a><b>&#167;9.3.3.2.1.  </b>A chapter whose title marks it as Independent becomes a new tangle target,
with the same language as the main web unless stated otherwise.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Mark this chapter as an independent tangle target</span> <span class="cwebmacronumber">9.3.3.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">language_name</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *"</span><span class="plain">))</span>
            <span class="identifier">language_name</span><span class="plain"> = </span><span class="functiontext">Bibliographic::get_datum</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Language"</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">language_name</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *(%c*?) *"</span><span class="plain">))</span>
            <span class="identifier">language_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0];</span>
        <span class="identifier">ind_language</span><span class="plain"> = </span><span class="functiontext">Languages::find_by_name</span><span class="plain">(</span><span class="identifier">language_name</span><span class="plain">);</span>
        <span class="identifier">ind_target</span><span class="plain"> = </span><span class="functiontext">Reader::add_tangle_target</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">ind_language</span><span class="plain">);</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_3_2">&#167;9.3.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_1"></a><b>&#167;9.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Create the new chapter with these details</span> <span class="cwebmacronumber">9.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">chapter</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_range</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">new_chapter_range</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;rubric</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_target</span><span class="plain"> = </span><span class="identifier">ind_target</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_weave</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_language</span><span class="plain"> = </span><span class="identifier">ind_language</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_extent</span><span class="plain"> = 0;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;titling_line_inserted</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;owning_web</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;imported</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;main_web_not_module</span><span class="plain">) </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;imported</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>

        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;owning_web</span><span class="plain">-</span><span class="element">&gt;no_chapters</span><span class="plain">++;</span>
        <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2">&#167;9.2</a>, <a href="#SP9_3_3_2">&#167;9.3.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2"></a><b>&#167;9.2.2.  </b>That's enough on creating chapters. This is the more interesting business
of registering a new section within a chapter &mdash; more interesting because
we also read in and process its file.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read about, and read in, a new section</span> <span class="cwebmacronumber">9.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">sect</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">section</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Initialise the section structure</span> <span class="cwebmacronumber">9.2.2.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Add the section to the web and the current chapter</span> <span class="cwebmacronumber">9.2.2.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Work out the language and tangle target for the section</span> <span class="cwebmacronumber">9.2.2.3</span>&gt;<span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            &lt;<span class="cwebmacro">Work out the filename of this section file</span> <span class="cwebmacronumber">9.2.2.4</span>&gt;<span class="plain">;</span>

        <span class="functiontext">Reader::read_file</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain">,</span>
            <span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;titling_line_to_insert</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;scan_verbosely</span><span class="plain">,</span>
            <span class="plain">(</span><span class="identifier">filename_of_single_file_web</span><span class="plain">)?</span><span class="constant">TRUE</span><span class="plain">:</span><span class="constant">FALSE</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2">&#167;9.2</a>, <a href="#SP9_3_3">&#167;9.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2_1"></a><b>&#167;9.2.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Initialise the section structure</span> <span class="cwebmacronumber">9.2.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filename_of_single_file_web</span><span class="plain">) {</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain"> = </span><span class="identifier">filename_of_single_file_web</span><span class="plain">;</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;paused_until_at</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;paused_until_at</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_extent</span><span class="plain"> = 0;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;first_line</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">; </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;last_line</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_paragraphs</span><span class="plain"> = 0;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;paragraphs</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">paragraph</span><span class="plain">);</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;macros</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">para_macro</span><span class="plain">);</span>

        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;scratch_flag</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;erroneous_interface</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;barred</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;using_syntax</span><span class="plain"> = </span><span class="identifier">syntax</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;is_a_singleton</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;printed_number</span><span class="plain"> = -1;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_weave</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_namespace</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>

        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c+) %^\</span><span class="plain">"</span><span class="string">(%c+)\</span><span class="plain">"</span><span class="string"> *"</span><span class="plain">)) {</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;tag_with</span><span class="plain"> = </span><span class="functiontext">Tags::add_by_name</span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;tag_with</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2_2">&#167;9.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2_2"></a><b>&#167;9.2.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Add the section to the web and the current chapter</span> <span class="cwebmacronumber">9.2.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;owning_web</span><span class="plain">-</span><span class="element">&gt;no_sections</span><span class="plain">++;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">;</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">sect</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2_2">&#167;9.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2_3"></a><b>&#167;9.2.2.3.  </b>Just as for chapters, but a section which is an independent target with
language "Inform 6" is given the filename extension <code class="display"><span class="extract">.i6t</span></code> instead of <code class="display"><span class="extract">.w</span></code>.
This is to conform with the naming convention used within Inform, where
I6 template files &mdash; Inweb files with language Inform 6 &mdash; are given the
file extensions <code class="display"><span class="extract">.i6t</span></code>.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Work out the language and tangle target for the section</span> <span class="cwebmacronumber">9.2.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_language</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain">-</span><span class="element">&gt;ch_language</span><span class="plain">; </span>    <span class="comment">by default</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*%C) %(Independent (%c*) *%)"</span><span class="plain">)) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title_alone</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0];</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">language_name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1];</span>
            &lt;<span class="cwebmacro">Mark this section as an independent tangle target</span> <span class="cwebmacronumber">9.2.2.3.1</span>&gt;<span class="plain">;</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_title</span><span class="plain">, </span><span class="identifier">title_alone</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_target</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_being_scanned</span><span class="plain">-</span><span class="element">&gt;ch_target</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2_2">&#167;9.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2_3_1"></a><b>&#167;9.2.2.3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Mark this section as an independent tangle target</span> <span class="cwebmacronumber">9.2.2.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain"> = </span><span class="identifier">language_name</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">p</span><span class="plain">) == 0) </span><span class="identifier">p</span><span class="plain"> = </span><span class="functiontext">Bibliographic::get_datum</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Language"</span><span class="plain">);</span>
        <span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">pl</span><span class="plain"> = </span><span class="functiontext">Languages::find_by_name</span><span class="plain">(</span><span class="identifier">p</span><span class="plain">);</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_language</span><span class="plain"> = </span><span class="identifier">pl</span><span class="plain">;</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_target</span><span class="plain"> = </span><span class="functiontext">Reader::add_tangle_target</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">, </span><span class="identifier">pl</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2_2_3">&#167;9.2.2.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_2_2_4"></a><b>&#167;9.2.2.4.  </b>If we're told that a section is called "Bells and Whistles", what filename
is it stored in? Firstly, the leafname is normally <code class="display"><span class="extract">Bells and Whistles.w</span></code>,
but the extension used doesn't have to be <code class="display"><span class="extract">.w</span></code>: for Inform 6 template files,
the extension needs to be <code class="display"><span class="extract">.i6t</span></code>, and a contents line like
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">Relations Template.i6t</span>
</pre>

<p class="inwebparagraph">translates into the leafname <code class="display"><span class="extract">Relations.i6t</span></code>, not <code class="display"><span class="extract">Relations Template.w</span></code>.
I6T files are also automatically set to Inweb syntax 1, for backwards
compatibility purposes.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Work out the filename of this section file</span> <span class="cwebmacronumber">9.2.2.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">leafname_to_use</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname_to_use</span><span class="plain">,</span>
            <span class="string">"%S%S"</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_title</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_language</span><span class="plain">-</span><span class="element">&gt;source_file_extension</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">leafname_to_use</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?) Template.i6t(%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">leafname_to_use</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname_to_use</span><span class="plain">, </span><span class="string">"%S.i6t%S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0], </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;path_to</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;current_web</span><span class="plain">-</span><span class="element">&gt;path_to_web</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">) &gt; 0)</span>
            <span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">RS</span><span class="plain">-</span><span class="element">&gt;chapter_folder_name</span><span class="plain">);</span>
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">leafname_to_use</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">ext</span><span class="plain">);</span>
        <span class="functiontext">Filenames::write_extension</span><span class="plain">(</span><span class="identifier">ext</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">ext</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">leafname_to_use</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_2_2">&#167;9.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Reading source files. </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::read_file</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">titling_line</span><span class="plain">, </span><span class="reserved">section</span><span class="plain"> *</span><span class="identifier">sect</span><span class="plain">,</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">verbosely</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">disregard_top</span><span class="plain">) {</span>
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">current_section</span><span class="plain"> = </span><span class="identifier">sect</span><span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">titling_line</span><span class="plain">) &amp;&amp; (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">titling_line</span><span class="plain">) &gt; 0) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain">-</span><span class="element">&gt;titling_line_inserted</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">))</span>
            &lt;<span class="cwebmacro">Insert an implied chapter heading</span> <span class="cwebmacronumber">10.1</span>&gt;<span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">disregard_top</span><span class="plain">)</span>
            &lt;<span class="cwebmacro">Insert an implied section heading, for a single-file web</span> <span class="cwebmacronumber">10.2</span>&gt;<span class="plain">;</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cl</span><span class="plain"> = </span><span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open section file"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">,</span>
            <span class="functiontext">Reader::scan_source_line</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, (</span><span class="reserved">void</span><span class="plain"> *) </span><span class="identifier">current_section</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">verbosely</span><span class="plain">)</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Read section: '%S' (%d lines)\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;sect_title</span><span class="plain">, </span><span class="identifier">cl</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::read_file is used in <a href="#SP9_2_2">&#167;9.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP10_1"></a><b>&#167;10.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert an implied chapter heading</span> <span class="cwebmacronumber">10.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">sect</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain">-</span><span class="element">&gt;titling_line_inserted</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        <span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="string">"Chapter Heading"</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Accept this as a line belonging to this section and chapter</span> <span class="cwebmacronumber">10.1.2</span>&gt;<span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP10_2"></a><b>&#167;10.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert an implied section heading, for a single-file web</span> <span class="cwebmacronumber">10.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        <span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="string">"Main."</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Accept this as a line belonging to this section and chapter</span> <span class="cwebmacronumber">10.1.2</span>&gt;<span class="plain">;</span>
        <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Accept this as a line belonging to this section and chapter</span> <span class="cwebmacronumber">10.1.2</span>&gt;<span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP10_1_1"></a><b>&#167;10.1.1.  </b>Non-implied source lines come from here. Note that we assume here that
trailing whitespace on a line is not significant in the language being
tangled for.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::scan_source_line</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">current_section</span><span class="plain"> = (</span><span class="reserved">section</span><span class="plain"> *) </span><span class="identifier">state</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">l</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">) - 1;</span>
        <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">l</span><span class="plain">&gt;=0) &amp;&amp; (</span><span class="functiontext">Characters::is_space_or_tab</span><span class="plain">(</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">l</span><span class="plain">)))) </span><span class="functiontext">Str::truncate</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">l</span><span class="plain">--);</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;paused_until_at</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, 0) == </span><span class="character">'@'</span><span class="plain">) </span><span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;paused_until_at</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="reserved">else</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        &lt;<span class="cwebmacro">Accept this as a line belonging to this section and chapter</span> <span class="cwebmacronumber">10.1.2</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::scan_source_line is used in <a href="#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP10_1_2"></a><b>&#167;10.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Accept this as a line belonging to this section and chapter</span> <span class="cwebmacronumber">10.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">source_line</span><span class="plain"> *</span><span class="identifier">sl</span><span class="plain"> = </span><span class="functiontext">Lines::new_source_line</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">);</span>

        <span class="comment">enter this in its section's linked list of lines:</span>
        <span class="identifier">sl</span><span class="plain">-</span><span class="element">&gt;owning_section</span><span class="plain"> = </span><span class="identifier">current_section</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;first_line</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;first_line</span><span class="plain"> = </span><span class="identifier">sl</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;last_line</span><span class="plain">-</span><span class="element">&gt;next_line</span><span class="plain"> = </span><span class="identifier">sl</span><span class="plain">;</span>
        <span class="identifier">current_section</span><span class="plain">-</span><span class="element">&gt;last_line</span><span class="plain"> = </span><span class="identifier">sl</span><span class="plain">;</span>

        <span class="comment">we haven't detected paragraph boundaries yet, so:</span>
        <span class="identifier">sl</span><span class="plain">-</span><span class="element">&gt;owning_paragraph</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

        <span class="comment">and keep count:</span>
        <span class="identifier">sl</span><span class="plain">-</span><span class="element">&gt;owning_section</span><span class="plain">-</span><span class="element">&gt;sect_extent</span><span class="plain">++;</span>
        <span class="identifier">sl</span><span class="plain">-</span><span class="element">&gt;owning_section</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain">-</span><span class="element">&gt;ch_extent</span><span class="plain">++;</span>
        <span class="identifier">sl</span><span class="plain">-</span><span class="element">&gt;owning_section</span><span class="plain">-</span><span class="element">&gt;owning_chapter</span><span class="plain">-</span><span class="element">&gt;owning_web</span><span class="plain">-</span><span class="element">&gt;no_lines</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP10_1">&#167;10.1</a>, <a href="#SP10_2">&#167;10.2</a> (twice), <a href="#SP10_1_1">&#167;10.1.1</a>.</p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. Looking up chapters and sections. </b>Given a range, which chapter or section does it correspond to? There is no
need for this to be at all quick: there are fewer than 1000 sections even
in large webs, and lookup is performed only a few times.
</p>

<p class="inwebparagraph">Note that range comparison is case sensitive.
</p>


<pre class="display">
    <span class="reserved">chapter</span><span class="plain"> *</span><span class="functiontext">Reader::get_chapter_for_range</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range</span><span class="plain">) {</span>
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">)</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ch_range</span><span class="plain">, </span><span class="identifier">range</span><span class="plain">))</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">C</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">section</span><span class="plain"> *</span><span class="functiontext">Reader::get_section_for_range</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range</span><span class="plain">) {</span>
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">)</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">)</span>
                <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain">)</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">-</span><span class="element">&gt;range</span><span class="plain">, </span><span class="identifier">range</span><span class="plain">))</span>
                        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">S</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::get_chapter_for_range is used in 3/ta (<a href="3-ta.html#SP1">&#167;1</a>).</p>

<p class="endnote">The function Reader::get_section_for_range is used in 1/pc (<a href="1-pc.html#SP7_2_2">&#167;7.2.2</a>, <a href="1-pc.html#SP7_2_2_2">&#167;7.2.2.2</a>), 3/ta (<a href="3-ta.html#SP1">&#167;1</a>).</p>

<p class="inwebparagraph"><a id="SP12"></a><b>&#167;12.  </b>This clumsy routine is never used in syntax version 2 or later.
</p>


<pre class="display">
    <span class="reserved">section</span><span class="plain"> *</span><span class="functiontext">Reader::section_by_filename</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="reserved">filename</span><span class="plain">) {</span>
        <span class="reserved">chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
        <span class="reserved">section</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">W</span><span class="plain">)</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">)</span>
                <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain">) {</span>
                    <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">SFN</span><span class="plain">);</span>
                    <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">SFN</span><span class="plain">, </span><span class="string">"%f"</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">-</span><span class="element">&gt;source_file_for_section</span><span class="plain">);</span>
                    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rv</span><span class="plain"> = </span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">SFN</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain">);</span>
                    <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">SFN</span><span class="plain">);</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rv</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">S</span><span class="plain">;</span>
                <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::section_by_filename appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP13"></a><b>&#167;13. Ranges and containment. </b>This provides a sort of partial ordering on ranges, testing if the portion
of the web represented by <code class="display"><span class="extract">range1</span></code> is contained inside the portion represented
by <code class="display"><span class="extract">range2</span></code>. Note that <code class="display"><span class="extract">"0"</span></code> means the entire web, and is what the word <code class="display"><span class="extract">all</span></code>
translates to when it's used on the command line.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Reader::range_within</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range1</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">range2</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">range2</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"0"</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">range1</span><span class="plain">, </span><span class="identifier">range2</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">range2</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c+/%c+"</span><span class="plain">)) { </span><span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">); </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">FALSE</span><span class="plain">; }</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">range1</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c+)/%c+"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0], </span><span class="identifier">range2</span><span class="plain">)) { </span><span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">); </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">TRUE</span><span class="plain">; }</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::range_within is used in 1/pc (<a href="1-pc.html#SP7_2_3_2">&#167;7.2.3.2</a>), 3/ts (<a href="3-ts.html#SP1">&#167;1</a>), 3/tw (<a href="3-tw.html#SP1_3">&#167;1.3</a>).</p>

<p class="inwebparagraph"><a id="SP14"></a><b>&#167;14. Tangle targets. </b>In Knuth's original conception of literate programming, a web produces
just one piece of tangled output &mdash; the program for compilation. But this
assumes that the underlying program is so simple that it won't require
ancillary files, configuration data, and such; and this is often just as
complex and worth explaining as the program itself. So Inweb allows a
web to contain multiple tangle targets, each of which contains a union of
sections. Each section belongs to exactly one tangle target; by default
a web contains just one target, which contains all of the sections.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">tangle_target</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">tangle_language</span><span class="plain">; </span>    <span class="comment">common to the entire contents</span>
        <span class="reserved">struct hash_table</span><span class="plain"> </span><span class="identifier">symbols</span><span class="plain">; </span>    <span class="comment">a table of identifiable names in this program</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">tangle_target</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure tangle_target is accessed in 3/ta, 3/tt and here.</p>

<p class="inwebparagraph"><a id="SP15"></a><b>&#167;15.  </b></p>


<pre class="display">
    <span class="reserved">tangle_target</span><span class="plain"> *</span><span class="functiontext">Reader::add_tangle_target</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">programming_language</span><span class="plain"> *</span><span class="identifier">language</span><span class="plain">) {</span>
        <span class="reserved">tangle_target</span><span class="plain"> *</span><span class="identifier">tt</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">tangle_target</span><span class="plain">);</span>
        <span class="identifier">tt</span><span class="plain">-</span><span class="element">&gt;tangle_language</span><span class="plain"> = </span><span class="identifier">language</span><span class="plain">;</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tt</span><span class="plain">, </span><span class="reserved">tangle_target</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;tangle_targets</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">tt</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::add_tangle_target is used in <a href="#SP2">&#167;2</a>, <a href="#SP9_3_3_2_1">&#167;9.3.3.2.1</a>, <a href="#SP9_2_2_3_1">&#167;9.2.2.3.1</a>.</p>

<p class="inwebparagraph"><a id="SP16"></a><b>&#167;16.  </b>And the following provides a way to iterate through the lines in a tangle,
while keeping the variables <code class="display"><span class="extract">C</span></code>, <code class="display"><span class="extract">S</span></code> and <code class="display"><span class="extract">L</span></code> pointing to the current chapter,
section and line.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="identifier">LOOP_WITHIN_TANGLE</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">)</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">chapter</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;chapters</span><span class="plain">)</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="reserved">section</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;sections</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain">-</span><span class="element">&gt;sect_target</span><span class="plain"> == </span><span class="identifier">T</span><span class="plain">)</span>
                    <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">source_line</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">S</span><span class="plain">-</span><span class="element">&gt;first_line</span><span class="plain">; </span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;next_line</span><span class="plain">)</span>
</pre>
<p class="inwebparagraph"><a id="SP17"></a><b>&#167;17. Additional header files. </b>Some C programs, in particular, may need additional header files added to
any tangle in order for them to compile. (The Inform project uses this to
get around the lack of some POSIX facilities on Windows.)
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reader::add_imported_header</span><span class="plain">(</span><span class="reserved">web</span><span class="plain"> *</span><span class="identifier">W</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">HF</span><span class="plain">) {</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">HF</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain">, </span><span class="identifier">W</span><span class="plain">-</span><span class="element">&gt;headers</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reader::add_imported_header is used in <a href="#SP9_3_3_2">&#167;9.3.3.2</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-bd.html">Back to 'Bibliographic Data'</a></li><li><a href="2-mdl.html">Continue with 'Modules'</a></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

