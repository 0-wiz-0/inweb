<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>5/htm</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '5/ee' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">foundation</a></li><li><a href="index.html#5">Chapter 5: Generating Websites</a></li><li><b>Epub Ebooks</b></li></ul><p class="purpose">To provide for wrapping up sets of HTML files into ePub ebooks.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Ebooks</a></li><li><a href="#SP5">&#167;5. Creation</a></li><li><a href="#SP6">&#167;6. Construction</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Ebooks. </b>Constructing an ePub file (essentially a zipped folder of HTML with some
metadata attached) is simple enough, but the details are finicky. The
HTML pages need to be fully XHTML compliant, which is quite a strict
requirement, and we can't help with that here. But we can at least sort
out the directory structure and the rather complicated indexing and
contents files also required.
</p>

<p class="inwebparagraph">See Liza Daly's invaluable tutorial "Build a digital book with EPUB" to
explicate all of this.
</p>

<p class="inwebparagraph">While under construction, any single ebook is represented by an instance
of the following structure. Conceptually, we will organise it as a series
of "volumes" (possibly only one), each of which is a series of "chapters"
(possibly only one). The actual content is a series of "pages", which are
essentially individual HTML files, plus some images.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">metadata_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">ebook_datum</span></code>: DCMI-standard bibliographic data</span>
        <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">prefix</span><span class="plain">; </span>    <span class="comment">to apply to the page leafnames</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CSS_file_throughout</span><span class="plain">; </span>    <span class="comment">where to find a CSS file to be used for all volumes</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">eventual_epub</span><span class="plain">; </span>    <span class="comment">filename of the final <code class="display"><span class="extract">*.epub</span></code> to be made</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">holder</span><span class="plain">; </span>    <span class="comment">directory to put the ingredients into</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">OEBPS_path</span><span class="plain">; </span>    <span class="comment">subdirectory which mysteriously has to be called <code class="display"><span class="extract">OEBPS</span></code></span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">ebook_volume_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">ebook_volume</span></code></span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">current_volume</span><span class="plain">; </span>    <span class="comment">the one to which chapters are now being added</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">ebook_chapter_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">ebook_chapter</span></code></span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="identifier">current_chapter</span><span class="plain">; </span>    <span class="comment">the one to which pages are now being added</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">ebook_page_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">book_page</span></code></span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">ebook_image_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">ebook_image</span></code></span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ebook is private to this section.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>DCMI, or "Dublin Core", metadata is a standard set of key-value pairs used to
identify ebooks; we need to maintain a small dictionary, and so small that a
list is entirely sufficient.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_datum</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">value</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_datum</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ebook_datum is accessed in 2/dct and here.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>As noted above, we use the following to stratify the book:
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_volume</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">volume_title</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">volume_starts</span><span class="plain">; </span>    <span class="comment">on which page the volume starts</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">CSS_file</span><span class="plain">; </span>    <span class="comment">where to find the CSS file to be included</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_volume</span><span class="plain">;</span>

    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_chapter</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">chapter_title</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">in_volume</span><span class="plain">; </span>    <span class="comment">to which volume this chapter belongs</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">chapter_starts</span><span class="plain">; </span>    <span class="comment">on which page the chapter starts</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">ebook_mark_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">ebook_mark</span></code>: for when multiple navigable points exist within this</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">start_URL</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_chapter</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ebook_volume is private to this section.</p>

<p class="endnote">The structure ebook_chapter is private to this section.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>Now for the actual resources which will end up in the EPUB. Here are the
pages:
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_page</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">page_title</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">page_type</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">page_ID</span><span class="plain">;</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">relative_URL</span><span class="plain">; </span>    <span class="comment">eventual URL of this page within the ebook</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">in_volume</span><span class="plain">; </span>    <span class="comment">to which volume this page belongs</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="identifier">in_chapter</span><span class="plain">; </span>    <span class="comment">to which chapter this page belongs</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">nav_entry_written</span><span class="plain">; </span>    <span class="comment">keep track of what we've written to the navigation tree</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_page</span><span class="plain">;</span>

    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_mark</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">mark_text</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">mark_URL</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_mark</span><span class="plain">;</span>

    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ebook_image</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">image_ID</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">relative_URL</span><span class="plain">; </span>    <span class="comment">eventual URL of this image within the ebook</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ebook_image</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ebook_page is private to this section.</p>

<p class="endnote">The structure ebook_mark is private to this section.</p>

<p class="endnote">The structure ebook_image is private to this section.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Creation. </b></p>


<pre class="display">
    <span class="reserved">ebook</span><span class="plain"> *</span><span class="functiontext">Epub::new</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title</span><span class="plain">, </span><span class="reserved">char</span><span class="plain"> *</span><span class="identifier">prefix</span><span class="plain">) {</span>
        <span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;metadata_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_datum</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;OEBPS_path</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_page</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_image_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_image</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_volume_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_volume</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_volume</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_chapter_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_chapter</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_chapter</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;eventual_epub</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;prefix</span><span class="plain"> = </span><span class="identifier">prefix</span><span class="plain">;</span>
        <span class="functiontext">Epub::attach_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"title"</span><span class="plain">, </span><span class="identifier">title</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">B</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Epub::use_CSS_throughout</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;CSS_file_throughout</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Epub::use_CSS</span><span class="plain">(</span><span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;CSS_file</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">text_stream</span><span class="plain"> *</span><span class="functiontext">Epub::attach_metadata</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">) {</span>
        <span class="reserved">ebook_datum</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="reserved">ebook_datum</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;metadata_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">)) {</span>
                <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="identifier">D</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_datum</span><span class="plain">);</span>
        <span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain"> = </span><span class="functiontext">Str::new_from_wide_string</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="reserved">ebook_datum</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;metadata_list</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">text_stream</span><span class="plain"> *</span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="reserved">ebook_datum</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="reserved">ebook_datum</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;metadata_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">))</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">text_stream</span><span class="plain"> *</span><span class="functiontext">Epub::ensure_metadata</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain"> = </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">S</span><span class="plain"> = </span><span class="functiontext">Epub::attach_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">S</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="functiontext">Epub::note_page</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">type</span><span class="plain">) {</span>
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_page</span><span class="plain">);</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;nav_entry_written</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_volume</span><span class="plain"> = </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_volume</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_chapter</span><span class="plain"> = </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_chapter</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">title</span><span class="plain">);</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_type</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">type</span><span class="plain">);</span>

        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;prefix</span><span class="plain">);</span>
        <span class="functiontext">Filenames::write_unextended_leafname</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
        <span class="identifier">LOOP_THROUGH_TEXT</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">) {</span>
            <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">c</span><span class="plain"> == </span><span class="character">'-'</span><span class="plain">) || (</span><span class="identifier">c</span><span class="plain"> == </span><span class="character">' '</span><span class="plain">)) </span><span class="functiontext">Str::put</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="character">'_'</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">P</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Epub::note_image</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="reserved">ebook_image</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_image</span><span class="plain">);</span>
        <span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">;</span>
        <span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;image_ID</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="functiontext">Filenames::write_unextended_leafname</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;image_ID</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">, </span><span class="reserved">ebook_image</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_image_list</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="functiontext">Epub::starts_volume</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title</span><span class="plain">) {</span>
        <span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_volume</span><span class="plain">);</span>
        <span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;volume_starts</span><span class="plain"> = </span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_volume</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;volume_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">title</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_volume</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;CSS_file</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">ebook_volume</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_volume_list</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">V</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="functiontext">Epub::starts_chapter</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">title</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">URL</span><span class="plain">) {</span>
        <span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_chapter</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;chapter_starts</span><span class="plain"> = </span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;in_volume</span><span class="plain"> = </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_volume</span><span class="plain">;</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;chapter_title</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">title</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;start_URL</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">URL</span><span class="plain">);</span>
        <span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ebook_mark_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">ebook_mark</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">ebook_chapter</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_chapter_list</span><span class="plain">);</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;current_chapter</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">;</span>
        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_chapter</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">C</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Epub::set_mark_in_chapter</span><span class="plain">(</span><span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">URL</span><span class="plain">) {</span>
        <span class="reserved">ebook_mark</span><span class="plain"> *</span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ebook_mark</span><span class="plain">);</span>
        <span class="identifier">M</span><span class="plain">-</span><span class="element">&gt;mark_text</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">);</span>
        <span class="identifier">M</span><span class="plain">-</span><span class="element">&gt;mark_URL</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">URL</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">M</span><span class="plain">, </span><span class="reserved">ebook_mark</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ebook_mark_list</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Epub::new appears nowhere else.</p>

<p class="endnote">The function Epub::use_CSS_throughout appears nowhere else.</p>

<p class="endnote">The function Epub::use_CSS appears nowhere else.</p>

<p class="endnote">The function Epub::attach_metadata appears nowhere else.</p>

<p class="endnote">The function Epub::get_metadata is used in <a href="#SP6">&#167;6</a>, <a href="#SP6_3">&#167;6.3</a>, <a href="#SP7_1">&#167;7.1</a>, <a href="#SP7_3_1">&#167;7.3.1</a>.</p>

<p class="endnote">The function Epub::ensure_metadata is used in <a href="#SP7_1">&#167;7.1</a>.</p>

<p class="endnote">The function Epub::note_page is used in <a href="#SP6_3">&#167;6.3</a>.</p>

<p class="endnote">The function Epub::note_image appears nowhere else.</p>

<p class="endnote">The function Epub::starts_volume appears nowhere else.</p>

<p class="endnote">The function Epub::starts_chapter appears nowhere else.</p>

<p class="endnote">The function Epub::set_mark_in_chapter appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Construction. </b>Note that if the client wants to use a cover image, it must also "note" this
image separately. (This is a little inconvenient, but indoc wants to do it
that way.)
</p>


<pre class="display">
    <span class="reserved">pathname</span><span class="plain"> *</span><span class="functiontext">Epub::begin_construction</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">, </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">cover_image</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>

        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">, </span><span class="string">"%S.epub"</span><span class="plain">, </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"title"</span><span class="plain">));</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;eventual_epub</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">TEMP</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">)</span>

        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Holder</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"ePub"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">Holder</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;holder</span><span class="plain"> = </span><span class="identifier">Holder</span><span class="plain">;</span>

        &lt;<span class="cwebmacro">Write the EPUB mimetype file</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the EPUB meta-inf directory</span> <span class="cwebmacronumber">6.2</span>&gt;<span class="plain">;</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">OEBPS</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Holder</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"OEBPS"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">OEBPS</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">cover_image</span><span class="plain">) </span>&lt;<span class="cwebmacro">Make the cover image page</span> <span class="cwebmacronumber">6.3</span>&gt;<span class="plain">;</span>
        <span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;OEBPS_path</span><span class="plain"> = </span><span class="identifier">OEBPS</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">OEBPS</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Epub::begin_construction appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the EPUB mimetype file</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">Mimetype</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Holder</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"mimetype"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">EM_struct</span><span class="plain">; </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">EM_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">Mimetype</span><span class="plain">, </span><span class="constant">ISO_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to open mimetype file for output: %f"</span><span class="plain">,</span>
                <span class="identifier">Mimetype</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"application/epub+zip"</span><span class="plain">); </span>    <span class="comment">EPUB requires there be no newline here</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_2"></a><b>&#167;6.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the EPUB meta-inf directory</span> <span class="cwebmacronumber">6.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">META_INF</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Holder</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"META-INF"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">META_INF</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">container</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">META_INF</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"container.xml"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">C_struct</span><span class="plain">; </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">C_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">container</span><span class="plain">, </span><span class="constant">ISO_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to open container file for output: %f"</span><span class="plain">,</span>
                <span class="identifier">container</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;?xml version=\</span><span class="plain">"</span><span class="string">1.0\</span><span class="plain">"</span><span class="string">?&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;container version=\</span><span class="plain">"</span><span class="string">1.0\</span><span class="plain">"</span><span class="string"> xmlns=\</span><span class="plain">"</span><span class="string">urn:oasis:names:tc:opendocument:xmlns:container\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">INDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;rootfiles&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">INDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;rootfile full-path=\</span><span class="plain">"</span><span class="string">OEBPS/content.opf\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">application/oebps-package+xml\</span><span class="plain">"</span><span class="string"> /&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">OUTDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/rootfiles&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">OUTDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/container&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_3"></a><b>&#167;6.3.  </b>It's a much-lamented fact that EPUB 2, at any rate, has no standard way
to define cover images, and different readers behave slightly differently.
But the following seems to work with iTunes 9.1 and later, and therefore
on Apple devices. (See Keith Fahlgren's post "Best practices in ePub cover
images" at the ThreePress Consulting blog.)
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Make the cover image page</span> <span class="cwebmacronumber">6.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">cover</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">OEBPS</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"cover.html"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">C_struct</span><span class="plain">; </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">C_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">cover</span><span class="plain">, </span><span class="constant">ISO_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to open cover file for output: %f"</span><span class="plain">,</span>
                <span class="identifier">cover</span><span class="plain">);</span>

        <span class="functiontext">Epub::note_page</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">cover</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Cover"</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"cover"</span><span class="plain">);</span>

        <span class="functiontext">HTML::declare_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">);</span>
        <span class="functiontext">HTML::begin_head</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="identifier">HTML_OPEN</span><span class="plain">(</span><span class="string">"title"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Cover"</span><span class="plain">);</span>
        <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"title"</span><span class="plain">);</span>
        <span class="identifier">HTML_OPEN_WITH</span><span class="plain">(</span><span class="string">"style"</span><span class="plain">, </span><span class="string">"type=\</span><span class="plain">"</span><span class="string">text/css\</span><span class="plain">"</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"img { max-width: 100%%; }\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"style"</span><span class="plain">);</span>
        <span class="functiontext">HTML::end_head</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="functiontext">HTML::begin_body</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="identifier">HTML_OPEN_WITH</span><span class="plain">(</span><span class="string">"div"</span><span class="plain">, </span><span class="string">"id=\</span><span class="plain">"</span><span class="string">cover-image\</span><span class="plain">"</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">HTML_TAG_WITH</span><span class="plain">(</span><span class="string">"img"</span><span class="plain">, </span><span class="string">"src=\</span><span class="plain">"</span><span class="string">%/f\</span><span class="plain">"</span><span class="string"> alt=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">"</span><span class="plain">, </span><span class="identifier">cover_image</span><span class="plain">, </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"title"</span><span class="plain">));</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"div"</span><span class="plain">);</span>
        <span class="functiontext">HTML::end_body</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="functiontext">HTML::completed</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Epub::end_construction</span><span class="plain">(</span><span class="reserved">ebook</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">) {</span>
        &lt;<span class="cwebmacro">Attach default metadata</span> <span class="cwebmacronumber">7.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the EPUB OPF file</span> <span class="cwebmacronumber">7.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the EPUB NCX file</span> <span class="cwebmacronumber">7.3</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Zip the EPUB</span> <span class="cwebmacronumber">7.4</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Epub::end_construction appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP7_1"></a><b>&#167;7.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Attach default metadata</span> <span class="cwebmacronumber">7.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">datestamp</span><span class="plain"> = </span><span class="functiontext">Epub::ensure_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"date"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">datestamp</span><span class="plain">) == 0) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">datestamp</span><span class="plain">, </span><span class="string">"%04d-%02d-%02d"</span><span class="plain">, </span><span class="identifier">the_present</span><span class="plain">-&gt;</span><span class="identifier">tm_year</span><span class="plain"> + 1900,</span>
                <span class="plain">(</span><span class="identifier">the_present</span><span class="plain">-&gt;</span><span class="identifier">tm_mon</span><span class="plain">)+1, </span><span class="identifier">the_present</span><span class="plain">-&gt;</span><span class="identifier">tm_mday</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">, </span><span class="string">"urn:www.inform7.com:"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">identifier</span><span class="plain"> = </span><span class="functiontext">Epub::ensure_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"identifier"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">identifier</span><span class="plain">) == 0)</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"title"</span><span class="plain">));</span>
        <span class="reserved">else</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">identifier</span><span class="plain">);</span>
        <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">identifier</span><span class="plain">, </span><span class="identifier">TEMP</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">TEMP</span><span class="plain">)</span>

        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">lang</span><span class="plain"> = </span><span class="functiontext">Epub::ensure_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"language"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">lang</span><span class="plain">) == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">lang</span><span class="plain">, </span><span class="string">"en-UK"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_2"></a><b>&#167;7.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the EPUB OPF file</span> <span class="cwebmacronumber">7.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">content</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;OEBPS_path</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"content.opf"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">C_struct</span><span class="plain">; </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">C_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">content</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to open content file for output: %f"</span><span class="plain">,</span>
                <span class="identifier">content</span><span class="plain">);</span>

        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;?xml version='1.0' encoding='utf-8'?&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;package xmlns=\</span><span class="plain">"</span><span class="string">http://www.idpf.org/2007/opf\</span><span class="plain">"</span><span class="string">\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"xmlns:dc=\</span><span class="plain">"</span><span class="string">http://purl.org/dc/elements/1.1/\</span><span class="plain">"</span><span class="string">\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"unique-identifier=\</span><span class="plain">"</span><span class="string">bookid\</span><span class="plain">"</span><span class="string"> version=\</span><span class="plain">"</span><span class="string">2.0\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the OPF metadata</span> <span class="cwebmacronumber">7.2.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the OPF manifest</span> <span class="cwebmacronumber">7.2.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the OPF spine</span> <span class="cwebmacronumber">7.2.3</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the OPF guide</span> <span class="cwebmacronumber">7.2.4</span>&gt;<span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/package&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>

        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_1"></a><b>&#167;7.2.1.  </b>The metadata here conforms to the Dublin Core Metadata Initiative (ebook_datum).
(Other default values are set in the configuration file.)
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Write the OPF metadata</span> <span class="cwebmacronumber">7.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;metadata&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="reserved">ebook_datum</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="reserved">ebook_datum</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;metadata_list</span><span class="plain">) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;dc:%S"</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"identifier"</span><span class="plain">)) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" id=\</span><span class="plain">"</span><span class="string">bookid\</span><span class="plain">"</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&gt;"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S&lt;/dc:%S&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;value</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-</span><span class="element">&gt;key</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;meta name=\</span><span class="plain">"</span><span class="string">cover\</span><span class="plain">"</span><span class="string"> content=\</span><span class="plain">"</span><span class="string">cover-image\</span><span class="plain">"</span><span class="string"> /&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/metadata&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2">&#167;7.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_2"></a><b>&#167;7.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the OPF manifest</span> <span class="cwebmacronumber">7.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;manifest&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;item id=\</span><span class="plain">"</span><span class="string">ncx\</span><span class="plain">"</span><span class="string"> href=\</span><span class="plain">"</span><span class="string">toc.ncx\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">application/x-dtbncx+xml\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Manifest the CSS files</span> <span class="cwebmacronumber">7.2.2.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Manifest the XHTML files</span> <span class="cwebmacronumber">7.2.2.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Manifest the images</span> <span class="cwebmacronumber">7.2.2.3</span>&gt;<span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/manifest&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2">&#167;7.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_2_1"></a><b>&#167;7.2.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Manifest the CSS files</span> <span class="cwebmacronumber">7.2.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cssc</span><span class="plain"> = 1;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;CSS_file_throughout</span><span class="plain">)</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;item id=\</span><span class="plain">"</span><span class="string">css%d\</span><span class="plain">"</span><span class="string"> href=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">text/css\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                    <span class="identifier">cssc</span><span class="plain">++, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;CSS_file_throughout</span><span class="plain">));</span>
        <span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">ebook_volume</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_volume_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;CSS_file</span><span class="plain">)</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;item id=\</span><span class="plain">"</span><span class="string">css%d\</span><span class="plain">"</span><span class="string"> href=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">text/css\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                    <span class="identifier">cssc</span><span class="plain">++, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;CSS_file</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2_2">&#167;7.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_2_2"></a><b>&#167;7.2.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Manifest the XHTML files</span> <span class="cwebmacronumber">7.2.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">)</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;item id=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> href=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">application/xhtml+xml\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2_2">&#167;7.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_2_3"></a><b>&#167;7.2.2.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Manifest the images</span> <span class="cwebmacronumber">7.2.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_image</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">, </span><span class="reserved">ebook_image</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_image_list</span><span class="plain">) {</span>
            <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">image_type</span><span class="plain"> = </span><span class="string">""</span><span class="plain">;</span>
            <span class="reserved">switch</span><span class="plain"> (</span><span class="functiontext">Filenames::guess_format</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">)) {</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="constant">FORMAT_PERHAPS_PNG</span><span class="plain">: </span><span class="identifier">image_type</span><span class="plain"> = </span><span class="string">"png"</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="constant">FORMAT_PERHAPS_JPEG</span><span class="plain">: </span><span class="identifier">image_type</span><span class="plain"> = </span><span class="string">"jpeg"</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="constant">FORMAT_PERHAPS_SVG</span><span class="plain">: </span><span class="identifier">image_type</span><span class="plain"> = </span><span class="string">"svg"</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="constant">FORMAT_PERHAPS_GIF</span><span class="plain">: </span><span class="identifier">image_type</span><span class="plain"> = </span><span class="string">"gif"</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">default</span><span class="plain">: </span><span class="functiontext">Errors::nowhere</span><span class="plain">(</span><span class="string">"image not .gif, .png, .jpg or .svg"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;item id=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> href=\</span><span class="plain">"</span><span class="string">%/f\</span><span class="plain">"</span><span class="string"> media-type=\</span><span class="plain">"</span><span class="string">image/%s\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;image_ID</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">, </span><span class="identifier">image_type</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2_2">&#167;7.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_3"></a><b>&#167;7.2.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the OPF spine</span> <span class="cwebmacronumber">7.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;spine toc=\</span><span class="plain">"</span><span class="string">ncx\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;itemref idref=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">"</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_type</span><span class="plain">) &gt; 0) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" linear=\</span><span class="plain">"</span><span class="string">no\</span><span class="plain">"</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/spine&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2">&#167;7.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_2_4"></a><b>&#167;7.2.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the OPF guide</span> <span class="cwebmacronumber">7.2.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;guide&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_type</span><span class="plain">) &gt; 0) {</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;reference href=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> type=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> title=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                    <span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">), </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_type</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_title</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/guide&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_2">&#167;7.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_3"></a><b>&#167;7.3.  </b>The NCX duplicates some of what's in the OPF file, for historical reasons;
it's left over from an earlier standard used by book-readers for visually
impaired people.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Write the EPUB NCX file</span> <span class="cwebmacronumber">7.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">toc</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;OEBPS_path</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"toc.ncx"</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">C_struct</span><span class="plain">; </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">C_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">toc</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to open ncx file for output: %f"</span><span class="plain">,</span>
                <span class="identifier">toc</span><span class="plain">);</span>

        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;?xml version='1.0' encoding='utf-8'?&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;!DOCTYPE ncx PUBLIC \</span><span class="plain">"</span><span class="string">-//NISO//DTD ncx 2005-1//EN\</span><span class="plain">"</span><span class="string">\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"	\</span><span class="plain">"</span><span class="string">http://www.daisy.org/z3986/2005/ncx-2005-1.dtd\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;ncx xmlns=\</span><span class="plain">"</span><span class="string">http://www.daisy.org/z3986/2005/ncx/\</span><span class="plain">"</span><span class="string"> version=\</span><span class="plain">"</span><span class="string">2005-1\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">depth</span><span class="plain"> = 1; </span>    <span class="comment">there are surely at least sections</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">LinkedLists::len</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_chapter_list</span><span class="plain">) &gt; 0) </span><span class="identifier">depth</span><span class="plain"> = 2;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">LinkedLists::len</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_volume_list</span><span class="plain">) &gt; 0) </span><span class="identifier">depth</span><span class="plain"> = 3;</span>

        &lt;<span class="cwebmacro">Write the NCX metadata</span> <span class="cwebmacronumber">7.3.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Write the NCX navigation map</span> <span class="cwebmacronumber">7.3.2</span>&gt;<span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/ncx&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>

        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_1"></a><b>&#167;7.3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the NCX metadata</span> <span class="cwebmacronumber">7.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;head&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;meta name=\</span><span class="plain">"</span><span class="string">dtb:uid\</span><span class="plain">"</span><span class="string"> content=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"identifier"</span><span class="plain">));</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;meta name=\</span><span class="plain">"</span><span class="string">dtb:depth\</span><span class="plain">"</span><span class="string"> content=\</span><span class="plain">"</span><span class="string">%d\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">depth</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;meta name=\</span><span class="plain">"</span><span class="string">dtb:totalPageCount\</span><span class="plain">"</span><span class="string"> content=\</span><span class="plain">"</span><span class="string">0\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;meta name=\</span><span class="plain">"</span><span class="string">dtb:maxPageNumber\</span><span class="plain">"</span><span class="string"> content=\</span><span class="plain">"</span><span class="string">0\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/head&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;docTitle&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;text&gt;%S&lt;/text&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Epub::get_metadata</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"title"</span><span class="plain">));</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/docTitle&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3">&#167;7.3</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2"></a><b>&#167;7.3.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Write the NCX navigation map</span> <span class="cwebmacronumber">7.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navMap&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">navpoint_count</span><span class="plain"> = 1;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">navmap_depth</span><span class="plain"> = 1;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> = 0;</span>
        &lt;<span class="cwebmacro">Include the non-section pages in this phase</span> <span class="cwebmacronumber">7.3.2.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">ebook_volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">ebook_volume</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_volume_list</span><span class="plain">) {</span>
            &lt;<span class="cwebmacro">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navLabel&gt;&lt;text&gt;%S&lt;/text&gt;&lt;/navLabel&gt;"</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;volume_title</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;content src=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;volume_starts</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">));</span>
            &lt;<span class="cwebmacro">Include the chapters and sections in this volume</span> <span class="cwebmacronumber">7.3.2.2</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">phase</span><span class="plain"> = 1;</span>
        &lt;<span class="cwebmacro">Include the non-section pages in this phase</span> <span class="cwebmacronumber">7.3.2.1</span>&gt;<span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/navMap&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">navmap_depth</span><span class="plain"> != 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"navMap numbering unbalanced"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3">&#167;7.3</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2_1"></a><b>&#167;7.3.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Include the non-section pages in this phase</span> <span class="cwebmacronumber">7.3.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">in_phase</span><span class="plain"> = 1;</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"cover"</span><span class="plain">)) ||</span>
                <span class="plain">(</span><span class="functiontext">Str::eq_wide_string</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_ID</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"index"</span><span class="plain">)))</span>
                <span class="identifier">in_phase</span><span class="plain"> = 0;</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">in_phase</span><span class="plain"> == </span><span class="identifier">phase</span><span class="plain">) &amp;&amp; (</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;nav_entry_written</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt;<span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navLabel&gt;&lt;text&gt;%S&lt;/text&gt;&lt;/navLabel&gt; &lt;content src=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                    <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_title</span><span class="plain">, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">));</span>
                &lt;<span class="cwebmacro">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt;<span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2">&#167;7.3.2</a> (twice).</p>

<p class="inwebparagraph"><a id="SP7_3_2_2"></a><b>&#167;7.3.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Include the chapters and sections in this volume</span> <span class="cwebmacronumber">7.3.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_chapter</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">ebook_chapter</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_chapter_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;in_volume</span><span class="plain"> == </span><span class="identifier">V</span><span class="plain">) {</span>
                &lt;<span class="cwebmacro">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt;<span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navLabel&gt;&lt;text&gt;%S&lt;/text&gt;&lt;/navLabel&gt;"</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;chapter_title</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;content src=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;start_URL</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ebook_mark_list</span><span class="plain">)</span>
                    &lt;<span class="cwebmacro">Include the marks in this chapter</span> <span class="cwebmacronumber">7.3.2.2.2</span>&gt;
                <span class="reserved">else</span>
                    &lt;<span class="cwebmacro">Include the sections in this chapter</span> <span class="cwebmacronumber">7.3.2.2.1</span>&gt;<span class="plain">;</span>
                <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
                <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">)</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_chapter</span><span class="plain"> == </span><span class="identifier">C</span><span class="plain">)</span>
                        <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;nav_entry_written</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                &lt;<span class="cwebmacro">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt;<span class="plain">;</span>
            <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2">&#167;7.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2_2_1"></a><b>&#167;7.3.2.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Include the sections in this chapter</span> <span class="cwebmacronumber">7.3.2.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_page</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">ebook_page</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;ebook_page_list</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;in_chapter</span><span class="plain"> == </span><span class="identifier">C</span><span class="plain">) &amp;&amp; (</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;nav_entry_written</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt;<span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navLabel&gt;&lt;text&gt;%S&lt;/text&gt;&lt;/navLabel&gt;"</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;page_title</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;content src=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;relative_URL</span><span class="plain">));</span>
                &lt;<span class="cwebmacro">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt;<span class="plain">;</span>
                <span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;nav_entry_written</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2_2">&#167;7.3.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2_2_2"></a><b>&#167;7.3.2.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Include the marks in this chapter</span> <span class="cwebmacronumber">7.3.2.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">ebook_mark</span><span class="plain"> *</span><span class="identifier">M</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">M</span><span class="plain">, </span><span class="reserved">ebook_mark</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;ebook_mark_list</span><span class="plain">) {</span>
            &lt;<span class="cwebmacro">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navLabel&gt;&lt;text&gt;%S&lt;/text&gt;&lt;/navLabel&gt;"</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">-</span><span class="element">&gt;mark_text</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;content src=\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">/&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">-</span><span class="element">&gt;mark_URL</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2_2">&#167;7.3.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2_3"></a><b>&#167;7.3.2.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Begin navPoint</span> <span class="cwebmacronumber">7.3.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;navPoint id=\</span><span class="plain">"</span><span class="string">navpoint-%d\</span><span class="plain">"</span><span class="string"> playOrder=\</span><span class="plain">"</span><span class="string">%d\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
            <span class="identifier">navpoint_count</span><span class="plain">, </span><span class="identifier">navpoint_count</span><span class="plain">);</span>
        <span class="identifier">navpoint_count</span><span class="plain">++;</span>
        <span class="identifier">navmap_depth</span><span class="plain">++; </span><span class="constant">INDENT</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2">&#167;7.3.2</a>, <a href="#SP7_3_2_1">&#167;7.3.2.1</a>, <a href="#SP7_3_2_2">&#167;7.3.2.2</a>, <a href="#SP7_3_2_2_1">&#167;7.3.2.2.1</a>, <a href="#SP7_3_2_2_2">&#167;7.3.2.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_2_4"></a><b>&#167;7.3.2.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">End navPoint</span> <span class="cwebmacronumber">7.3.2.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">navmap_depth</span><span class="plain">--;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">navmap_depth</span><span class="plain"> &lt; 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"navMap numbering awry"</span><span class="plain">);</span>
        <span class="constant">OUTDENT</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/navPoint&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3_2">&#167;7.3.2</a>, <a href="#SP7_3_2_1">&#167;7.3.2.1</a>, <a href="#SP7_3_2_2">&#167;7.3.2.2</a>, <a href="#SP7_3_2_2_1">&#167;7.3.2.2.1</a>, <a href="#SP7_3_2_2_2">&#167;7.3.2.2.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_4"></a><b>&#167;7.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Zip the EPUB</span> <span class="cwebmacronumber">7.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">up</span><span class="plain"> = </span><span class="functiontext">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">".."</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">ePub_relative</span><span class="plain"> =</span>
            <span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">up</span><span class="plain">, </span><span class="functiontext">Filenames::get_leafname</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;eventual_epub</span><span class="plain">));</span>
        &lt;<span class="cwebmacro">Issue first zip instruction</span> <span class="cwebmacronumber">7.4.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Issue second zip instruction</span> <span class="cwebmacronumber">7.4.2</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_4_1"></a><b>&#167;7.4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Issue first zip instruction</span> <span class="cwebmacronumber">7.4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cd "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;holder</span><span class="plain">);</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"; zip -0Xq "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">ePub_relative</span><span class="plain">);</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">" mimetype"</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_4">&#167;7.4</a>.</p>

<p class="inwebparagraph"><a id="SP7_4_2"></a><b>&#167;7.4.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Issue second zip instruction</span> <span class="cwebmacronumber">7.4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cd "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">-</span><span class="element">&gt;holder</span><span class="plain">);</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"; zip -Xr9Dq "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">ePub_relative</span><span class="plain">);</span>
        <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">" *"</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_4">&#167;7.4</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="5-htm.html">Back to 'HTML'</a></li><li><i>(This section ends Chapter 5: Generating Websites.)</i></li></ul><hr class="tocbar">
<!--End of weave: 598 lines from a web of 9333-->
	</body>
</html>

