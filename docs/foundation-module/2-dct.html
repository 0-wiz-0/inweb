<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/llas</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../inweb/index.html">inweb</a></li>
</ul>
<h2>Foundation</h2>
<ul>
<li><a href="../foundation-module/index.html">foundation-module</a></li>
<li><a href="../foundation-test/index.html">foundation-test</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of '2/dct' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="index.html">foundation</a></li><li><a href="index.html#2">Chapter 2: Memory, Streams and Collections</a></li><li><b>Dictionaries</b></li></ul><p class="purpose">A simple implementation for a flexible-sized dictionary of key-value pairs.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Storage</a></li><li><a href="#SP2">&#167;2. Creation</a></li><li><a href="#SP3">&#167;3. Logging</a></li><li><a href="#SP4">&#167;4. Hashing</a></li><li><a href="#SP5">&#167;5. Create, find, destroy</a></li><li><a href="#SP8">&#167;8. Accessing entries</a></li><li><a href="#SP11">&#167;11. Disposal</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Storage. </b>There's nothing fancy here. A "dictionary" is a hash table allowing reasonably
efficient lookup: it's a correspondence between "keys", which are texts, and
pointers to some external structure. Often these will also be texts, but
not necessarily.
</p>


<pre class="display">
    <span class="identifier">typedef</span><span class="plain"> </span><span class="identifier">struct</span><span class="plain"> </span><span class="identifier">dictionary</span><span class="plain"> {</span>
        <span class="identifier">int</span><span class="plain"> </span><span class="identifier">textual</span><span class="plain">; </span><span class="comment">values are texts?</span>
        <span class="identifier">int</span><span class="plain"> </span><span class="identifier">no_entries</span><span class="plain">; </span><span class="comment">total number of key-value pairs currently stored here</span>
        <span class="identifier">int</span><span class="plain"> </span><span class="identifier">hash_table_size</span><span class="plain">; </span><span class="comment">size of array...</span>
        <span class="identifier">struct</span><span class="plain"> </span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">hash_table</span><span class="plain">; </span><span class="comment">...of linked lists of dictionary entries</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="identifier">dictionary</span><span class="plain">;</span>

    <span class="identifier">typedef</span><span class="plain"> </span><span class="identifier">struct</span><span class="plain"> </span><span class="identifier">dict_entry</span><span class="plain"> {</span>
        <span class="identifier">int</span><span class="plain"> </span><span class="identifier">vacant</span><span class="plain">; </span><span class="comment">a "vacant" entry is not currently used to store a k-v pair</span>
        <span class="identifier">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">; </span><span class="comment">for non-vacant entries only: the key text</span>
        <span class="identifier">void</span><span class="plain"> *</span><span class="identifier">value</span><span class="plain">; </span><span class="comment">for non-vacant entries only: the value, some kind of pointer</span>
        <span class="identifier">struct</span><span class="plain"> </span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">next_in_entry</span><span class="plain">;</span>
    <span class="plain">} </span><span class="identifier">dict_entry</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure dictionary is private to this section.</p>

<p class="endnote">The structure dict_entry is accessed in 5/ee, 8/bdfw and here.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Creation. </b>Dictionaries can have arbitrary size, in that they expand as needed, but for
efficiency's sake the caller can set them up with an initial size of her choice.
</p>


<pre class="display">
    <span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">Dictionaries::new</span><span class="plain">(</span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">S</span><span class="plain">, </span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">textual</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain"> &lt; </span><span class="constant">2</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"dictionary too small"</span><span class="plain">);</span>
        <span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain">);</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain"> = </span><span class="identifier">textual</span><span class="plain">;</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain"> = </span><span class="identifier">S</span><span class="plain">;</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">no_entries</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain"> = </span><span class="identifier">Memory::I7_calloc</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="identifier">sizeof</span><span class="plain">(</span><span class="identifier">dict_entry</span><span class="plain">), </span><span class="identifier">DICTIONARY_MREASON</span><span class="plain">);</span>
        <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">S</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">].</span><span class="identifier">vacant</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">].</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">].</span><span class="identifier">next_in_entry</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">D</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::new is used in <a href="#SP7_2">&#167;7.2</a>, 3/cla (<a href="3-cla.html#SP5">&#167;5</a>), 4/sm (<a href="4-sm.html#SP26_1">&#167;26.1</a>).</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Logging. </b></p>


<pre class="display">
    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::log</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Dictionary:\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, (</span><span class="identifier">unsigned</span><span class="plain"> </span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">D</span><span class="plain">); </span><span class="identifier">INDENT</span><span class="plain">;</span>
        <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Slot %02d:"</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">);</span>
            <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = &amp;(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]); </span><span class="identifier">E</span><span class="plain">; </span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">next_in_entry</span><span class="plain">)</span>
                <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" vacant"</span><span class="plain">);</span>
                <span class="identifier">else</span><span class="plain"> </span><span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" %S='%S'"</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">key</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">);</span>
                <span class="identifier">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" %S=%08x"</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">key</span><span class="plain">, (</span><span class="identifier">unsigned</span><span class="plain"> </span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">OUTDENT</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::log appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Hashing. </b>The whole point of a hash table is that it crudely sorts the contents by a rough
indication of the key values. This crude indication is the hash value, calculated
here. If there are <code class="display"><span class="extract">N</span></code> slots in the dictionary table, this tells us which slot
(from 0 to <code class="display"><span class="extract">N-1</span></code>) a given key value belongs in.
</p>


<pre class="display">
    <span class="identifier">int</span><span class="plain"> </span><span class="identifier">Dictionaries::hash</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">) {</span>
        <span class="identifier">unsigned</span><span class="plain"> </span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">hash</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">LOOP_THROUGH_TEXT</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">)</span>
            <span class="identifier">hash</span><span class="plain"> = </span><span class="constant">16339</span><span class="plain">*</span><span class="identifier">hash</span><span class="plain"> + ((</span><span class="identifier">unsigned</span><span class="plain"> </span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">Str::get</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">));</span>
        <span class="identifier">return</span><span class="plain"> (</span><span class="identifier">int</span><span class="plain">) (</span><span class="identifier">hash</span><span class="plain"> % ((</span><span class="identifier">unsigned</span><span class="plain"> </span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">N</span><span class="plain">));</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::hash is used in <a href="#SP7_3">&#167;7.3</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Create, find, destroy. </b>These three fundamental operations locate the dictionary entry structure for
a given key value, and then do something to/with it. Note that these pointers
remain valid only until somebody writes a new value into the dictionary;
so be careful if thread safety's an issue.
</p>


<pre class="display">
    <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">Dictionaries::find</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">Dictionaries::find_p</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">, </span><span class="constant">0</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">Dictionaries::create</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">Dictionaries::find_p</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">, </span><span class="constant">1</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::destroy</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="identifier">Dictionaries::find_p</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">, -1);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::find is used in <a href="#SP6">&#167;6</a>, <a href="#SP8">&#167;8</a>, <a href="#SP10">&#167;10</a>, 3/cla (<a href="3-cla.html#SP13">&#167;13</a>).</p>

<p class="endnote">The function Dictionaries::create is used in <a href="#SP6">&#167;6</a>, <a href="#SP9">&#167;9</a>, 3/cla (<a href="3-cla.html#SP5">&#167;5</a>).</p>

<p class="endnote">The function Dictionaries::destroy is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>A nuisance we have to live with is that we often want to express the key
as wide text (so that we can use literals like <code class="display"><span class="extract">L"my-key"</span></code>) instead of text
streams. So we also offer versions suffixed <code class="display"><span class="extract">_literal</span></code>:
</p>


<pre class="display">
    <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">Dictionaries::find_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">lit</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="string">"%w"</span><span class="plain">, </span><span class="identifier">lit</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">Dictionaries::create_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">lit</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="string">"%w"</span><span class="plain">, </span><span class="identifier">lit</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::create</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::destroy_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">lit</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="string">"%w"</span><span class="plain">, </span><span class="identifier">lit</span><span class="plain">);</span>
        <span class="identifier">Dictionaries::destroy</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::find_literal is used in <a href="#SP8">&#167;8</a>, <a href="#SP10">&#167;10</a>.</p>

<p class="endnote">The function Dictionaries::create_literal is used in <a href="#SP9">&#167;9</a>, 4/sm (<a href="4-sm.html#SP26_1">&#167;26.1</a>).</p>

<p class="endnote">The function Dictionaries::destroy_literal appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>So, then, find an entry (if <code class="display"><span class="extract">change</span></code> is <code class="display"><span class="extract">0</span></code>), create it (if <code class="display"><span class="extract">+1</span></code>) or delete
it (if <code class="display"><span class="extract">-1</span></code>).
</p>


<pre class="display">
    <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">Dictionaries::find_p</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">change</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span>&lt;<span class="cwebmacro">Handle the null dictionary</span> <span class="cwebmacronumber">7.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">change</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) </span>&lt;<span class="cwebmacro">Expand the dictionary if necessary</span> <span class="cwebmacronumber">7.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Work within the existing dictionary</span> <span class="cwebmacronumber">7.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::find_p is used in <a href="#SP5">&#167;5</a>, <a href="#SP7_2">&#167;7.2</a>.</p>

<p class="inwebparagraph"><a id="SP7_1"></a><b>&#167;7.1.  </b>It's legal to perform a find on the null dictionary: the answer's always "no".
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Handle the null dictionary</span> <span class="cwebmacronumber">7.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">change</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"tried to create or destroy in a null dictionary"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_2"></a><b>&#167;7.2.  </b>For speed, our policy is that the hash table should have roughly the
same number of slots as there are entries in the dictionary; that way, each
slot will have an average of one or fewer entries. When we exceed this
ideal population, we double the dictionary's capacity.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Expand the dictionary if necessary</span> <span class="cwebmacronumber">7.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">no_entries</span><span class="plain"> &gt; </span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">) {</span>
            <span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D2</span><span class="plain"> = </span><span class="identifier">Dictionaries::new</span><span class="plain">(2*</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">);</span>
            <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
                <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = &amp;(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]); </span><span class="identifier">E</span><span class="plain">; </span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">next_in_entry</span><span class="plain">)</span>
                    <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) {</span>
                        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E2</span><span class="plain"> = </span><span class="identifier">Dictionaries::find_p</span><span class="plain">(</span><span class="identifier">D2</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">key</span><span class="plain">, </span><span class="constant">1</span><span class="plain">);</span>
                        <span class="identifier">E2</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
                    <span class="plain">}</span>
            <span class="identifier">Memory::I7_free</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">, </span><span class="identifier">DICTIONARY_MREASON</span><span class="plain">,</span>
                <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">*((</span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">sizeof</span><span class="plain">(</span><span class="identifier">dict_entry</span><span class="plain">)));</span>
            <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain"> = </span><span class="identifier">D2</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">;</span>
            <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain"> = </span><span class="identifier">D2</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_3"></a><b>&#167;7.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Work within the existing dictionary</span> <span class="cwebmacronumber">7.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">last_E</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = &amp;(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">Dictionaries::hash</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">)]);</span>
            <span class="identifier">E</span><span class="plain">; </span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">next_in_entry</span><span class="plain">) {</span>
            <span class="identifier">last_E</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">;</span>
            <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) {</span>
                <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">change</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) { </span>&lt;<span class="cwebmacro">Make E the new entry</span> <span class="cwebmacronumber">7.3.1</span>&gt;<span class="plain">; </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">; }</span>
            <span class="plain">} </span><span class="identifier">else</span><span class="plain"> {</span>
                <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">Str::eq</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">key</span><span class="plain">)) {</span>
                    <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">change</span><span class="plain"> == -1) </span>&lt;<span class="cwebmacro">Destroy the E entry</span> <span class="cwebmacronumber">7.3.2</span>&gt;<span class="plain">;</span>
                    <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">change</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) {</span>
            <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="identifier">dict_entry</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Make E the new entry</span> <span class="cwebmacronumber">7.3.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">last_E</span><span class="plain">-&gt;</span><span class="identifier">next_in_entry</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">;</span>
            <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_3_1"></a><b>&#167;7.3.1.  </b>When creating text values, we want them to be empty strings rather than null
strings, so that printing to them will work.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Make E the new entry</span> <span class="cwebmacronumber">7.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">(); </span><span class="identifier">else</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">key</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">no_entries</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3">&#167;7.3</a> (twice).</p>

<p class="inwebparagraph"><a id="SP7_3_2"></a><b>&#167;7.3.2.  </b>When deleting text values, we close them first, to give back the memory.
Careful: it would not be thread-safe to allow different threads to use the
same dictionary if deletions are a possibility.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Destroy the E entry</span> <span class="cwebmacronumber">7.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">; </span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">no_entries</span><span class="plain">--;</span>
        <span class="identifier">if</span><span class="plain"> ((</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) &amp;&amp; (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">)) </span><span class="identifier">Str::dispose_of</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_3">&#167;7.3</a>.</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Accessing entries. </b>Eventually we're going to want the value. In principle we could be storing
values which are arbitrary pointers, so we have to use void pointers:
</p>


<pre class="display">
    <span class="identifier">void</span><span class="plain"> *</span><span class="identifier">Dictionaries::read_value</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"textual dictionary accessed as pointy"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"read null dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"read vacant dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="identifier">void</span><span class="plain"> *</span><span class="identifier">Dictionaries::read_value_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"textual dictionary accessed as pointy"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find_literal</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"read null dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"read vacant dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::write_value</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">, </span><span class="identifier">void</span><span class="plain"> *</span><span class="identifier">val</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote to null dictionary"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"textual dictionary accessed as pointy"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote null dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote vacant dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">val</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::write_value_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">, </span><span class="identifier">void</span><span class="plain"> *</span><span class="identifier">val</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote to null dictionary"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"textual dictionary accessed as pointy"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find_literal</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote null dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote vacant dictionary entry"</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain"> = </span><span class="identifier">val</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::read_value is used in 3/cla (<a href="3-cla.html#SP13">&#167;13</a>).</p>

<p class="endnote">The function Dictionaries::read_value_literal appears nowhere else.</p>

<p class="endnote">The function Dictionaries::write_value is used in 3/cla (<a href="3-cla.html#SP5">&#167;5</a>).</p>

<p class="endnote">The function Dictionaries::write_value_literal appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9.  </b>But the commonest use case is that the dictionary stores texts as values,
so we provide convenient wrappers with the correct C types.
</p>


<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote to null dictionary"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"pointy dictionary accessed as textual"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::create</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> (</span><span class="identifier">text_stream</span><span class="plain"> *) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">Dictionaries::create_text_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">lit</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"wrote to null dictionary"</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"pointy dictionary accessed as textual"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::create_literal</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">lit</span><span class="plain">);</span>
        <span class="identifier">return</span><span class="plain"> (</span><span class="identifier">text_stream</span><span class="plain"> *) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::create_text appears nowhere else.</p>

<p class="endnote">The function Dictionaries::create_text_literal appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10.  </b>We only need a read operation, because the caller can write to the dictionary
entry by reading the text pointer and then using <code class="display"><span class="extract">WRITE_TO</span></code>.
</p>


<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">Dictionaries::get_text</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"pointy dictionary accessed as textual"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">return</span><span class="plain"> (</span><span class="identifier">text_stream</span><span class="plain"> *) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">Dictionaries::get_text_literal</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">lit</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"pointy dictionary accessed as textual"</span><span class="plain">);</span>
        <span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">Dictionaries::find_literal</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">lit</span><span class="plain">);</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">return</span><span class="plain"> (</span><span class="identifier">text_stream</span><span class="plain"> *) </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::get_text appears nowhere else.</p>

<p class="endnote">The function Dictionaries::get_text_literal is used in 4/sm (<a href="4-sm.html#SP26_1">&#167;26.1</a>).</p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. Disposal. </b>If a dictionary was only needed temporarily then we should dispose of it
and free the memory when done:
</p>


<pre class="display">
    <span class="identifier">void</span><span class="plain"> </span><span class="identifier">Dictionaries::dispose_of</span><span class="plain">(</span><span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">textual</span><span class="plain">)</span>
            <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
                <span class="identifier">for</span><span class="plain"> (</span><span class="identifier">dict_entry</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = &amp;(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]); </span><span class="identifier">E</span><span class="plain">; </span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">next_in_entry</span><span class="plain">)</span>
                    <span class="identifier">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">vacant</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">)</span>
                        <span class="identifier">Str::dispose_of</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">-&gt;</span><span class="identifier">value</span><span class="plain">);</span>
        <span class="identifier">Memory::I7_free</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain">, </span><span class="identifier">DICTIONARY_MREASON</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table_size</span><span class="plain">*((</span><span class="identifier">int</span><span class="plain">) </span><span class="identifier">sizeof</span><span class="plain">(</span><span class="identifier">dict_entry</span><span class="plain">)));</span>
        <span class="identifier">D</span><span class="plain">-&gt;</span><span class="identifier">hash_table</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Dictionaries::dispose_of appears nowhere else.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-llas.html">Back to 'Linked Lists and Stacks'</a></li><li><i>(This section ends Chapter 2: Memory, Streams and Collections.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

